# 日常工作流程

## 会话开始：恢复上下文

### 步骤

```bash
# 1. 拉取最新代码
git pull --rebase

# 2. 运行快速验证
npm run verify:fast

# 3. 运行健康检查
npm run workflow:doctor

# 4. 构建内存索引
npm run memory:context -- -Stage index
```

### AI 助手操作

在 Claude Code 中输入：

```
/trellis:start
```

这会自动：
- 读取开发者身份
- 检查 git 状态
- 读取最近会话历史
- 识别活跃变更

## 开发中：持续验证

### 原则

1. **一次只做一个变更** - 不要同时修改多个 OpenSpec change
2. **小步提交** - 每个有意义的代码批次后运行 `npm run verify:fast`
3. **保持同步** - tasks.md 和代码进度保持一致

### 验证频率

| 阶段 | 命令 | 频率 |
|------|------|------|
| 编码中 | `npm run verify:fast` | 每次有意义改动后 |
| 准备提交 | `npm run verify` | 提交前 |
| PR 前 | `npm run verify:ci` | PR 创建前 |

### 重复失败处理

如果验证反复失败，使用有界循环：

```bash
npm run verify:loop -- -Profile fast -MaxAttempts 2
```

这会：
- 最多尝试 2 次验证
- 记录诊断信息到 `.metrics/verify-fix-loop.jsonl`
- 提供结构化的失败分析

## 会话结束：记录成果

### 步骤

```bash
# 1. 记录会话
/trellis:record-session

# 2. 如有新经验，更新文档
# 编辑 xxx_docs/ 或 .trellis/gotchas/
```

### 会话证据要求

在 `.trellis/workspace/<owner>/journal-N.md` 中包含：

```markdown
## Memory Sources
- .trellis/spec/guides/
- openspec/specs/

## Disclosure Level
- full

## Source IDs
- S001, S003
```

## 完整 SOP 检查清单

### 每日开始

- [ ] `git pull --rebase`
- [ ] `npm run verify:fast`
- [ ] `npm run workflow:doctor`
- [ ] `npm run memory:context -- -Stage index`
- [ ] 运行 `/trellis:start`

### 开发过程

- [ ] 只在单个 OpenSpec change 范围内工作
- [ ] 保持 tasks.md 与代码同步
- [ ] 每次有意义改动后运行 `npm run verify:fast`

### 提交前

- [ ] `npm run verify`
- [ ] `npm run workflow:policy`
- [ ] `openspec validate --all --strict --no-interactive`
- [ ] `npm run workflow:gate`
- [ ] 更新 tasks.md 验证证据

### 会话结束

- [ ] `/trellis:record-session`
- [ ] 如有新经验，更新 gotchas/

## 常用命令速查

```bash
# === 验证 ===
npm run verify:fast              # 快速验证（~10s）
npm run verify                   # 完整验证（~30s）
npm run verify:ci                # CI 等价验证
npm run verify:loop -- -Profile fast -MaxAttempts 2  # 有界循环

# === 策略 ===
npm run workflow:policy          # 策略门禁
npm run workflow:gate            # 指标门禁
npm run workflow:doctor          # 健康检查

# === 指标 ===
npm run metrics:collect          # 采集指标
npm run metrics:report           # 生成周报
npm run metrics:report:last      # 最近 4 周报告

# === 变更 ===
openspec new change <name>       # 创建变更
openspec status                  # 查看活跃变更
openspec status --change <name>  # 查看特定变更
openspec archive <name> -y       # 归档变更

# === 内存 ===
npm run memory:context -- -Stage index              # 索引阶段
npm run memory:context -- -Stage detail -Ids S001   # 详情阶段

# === 秘密扫描 ===
npm run secret:scan              # 扫描暂存文件
npm run secret:scan:diff         # 扫描差异
npm run secret:baseline          # 更新基线
```
