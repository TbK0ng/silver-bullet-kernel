# 最佳实践

## 架构原则

### 资产即真理

```
❌ 错误：知识在对话中，会话结束即丢失
✅ 正确：知识在文件中，版本控制、可追溯
```

**实践：**
- 重要决策写入 proposal.md
- 技术设计写入 design.md
- 经验教训写入 gotchas/

### 单一职责

```
❌ 错误：一个变更解决多个不相关问题
✅ 正确：一个变更只解决一个明确的问题
```

**实践：**
- 变更名称清晰描述单一目标
- 范围蔓延时创建新变更

## 编码实践

### 任务粒度

```
❌ 错误：任务描述模糊，无法验证
✅ 正确：任务小而可验证，有明确完成标准
```

**好的任务示例：**
```markdown
| ID | 任务 | 验证标准 |
|----|------|----------|
| T1 | 添加用户登录 API | POST /api/login 返回 200 |
| T2 | 添加密码哈希 | 密码使用 bcrypt 存储 |
| T3 | 添加登录测试 | 测试覆盖率 > 80% |
```

### 确定性验证

```
❌ 错误：依赖人工检查
✅ 正确：使用自动化脚本验证
```

**实践：**
- 编写测试而非手动验证
- 使用 lint 和 typecheck
- 在 tasks.md 中记录验证命令

### 语义化重构

```
❌ 错误：使用文本替换重命名符号
✅ 正确：使用语义化重构工具
```

```bash
# 语义重命名（推荐）
npm run refactor:rename -- \
  --file src/app.ts \
  --line 42 \
  --column 7 \
  --newName createTaskPayload \
  --dryRun

# 而不是文本替换（危险）
sed -i 's/oldName/newName/g' src/*.ts
```

## 流程实践

### 变更管理

```
❌ 错误：跳过 proposal 直接写代码
✅ 正确：proposal → design → tasks → 实现
```

**顺序：**
1. 先写 proposal（意图）
2. 再写 design（方案）
3. 拆分 tasks（任务）
4. 最后实现（代码）

### 任务证据

```
❌ 错误：声称完成但无证据
✅ 正确：每次任务有验证证据
```

**必需格式：**
```markdown
### Task Evidence

| ID | Status | Files | Action | Verify | Done |
|----|--------|-------|--------|--------|------|
| T1 | done | src/auth.ts | 添加登录 | npm run verify:fast | ✅ 通过 |
```

### 有界循环

```
❌ 错误：无限尝试修复验证失败
✅ 正确：使用有界循环，收集诊断
```

```bash
# 有界循环（推荐）
npm run verify:loop -- -Profile fast -MaxAttempts 2

# 检查诊断结果
cat .metrics/verify-fix-loop.jsonl
```

### 及时归档

```
❌ 错误：完成的变更长期不归档
✅ 正确：验证通过后立即归档
```

**好处：**
- 减少 worktree 污染
- 规格及时合并
- 历史清晰可追溯

## 协作实践

### Worktree 隔离

```
❌ 错误：在 main worktree 中实现变更
✅ 正确：在 linked worktree 中隔离工作
```

**好处：**
- 避免污染主工作区
- 支持并行开发
- 回滚更容易

### 短生命周期分支

```
❌ 错误：分支存活数周
✅ 正确：分支在几天内合并
```

**实践：**
- 拆分大变更
- 频繁 rebase
- 及时合并

### 会话记录

```
❌ 错误：会话结束不记录
✅ 正确：使用 /trellis:record-session 记录
```

**记录内容：**
- 完成的工作
- 遇到的问题
- 学到的经验
- 下一步计划

## 文档实践

### 及时更新

```
❌ 错误：实现完成后才更新文档
✅ 正确：实现过程中同步更新
```

**需要更新的内容：**
- xxx_docs/ 运维文档
- gotchas/ 经验教训
- tasks.md 任务状态

### 可复现性

```
❌ 错误：文档缺少具体命令
✅ 正确：文档包含完整的可执行命令
```

**好的文档：**
```markdown
## 验证步骤

1. 运行验证命令：
   ```bash
   npm run verify:fast
   ```

2. 检查输出，确认无错误

3. 如有失败，运行诊断：
   ```bash
   npm run workflow:doctor
   ```
```

## 安全实践

### 秘密管理

```
❌ 错误：凭证提交到仓库
✅ 正确：使用 .env 文件，添加到 .gitignore
```

**处理流程：**
1. 检测到秘密 → 立即停止
2. 删除或脱敏
3. 如已泄露 → 重新生成凭证
4. 运行 `npm run secret:scan` 确认

### 敏感路径

```
❌ 错误：修改 .env、*.key 等敏感文件
✅ 正确：这些文件在 policy.yaml 中禁止
```

**禁止路径（policy.yaml）：**
```yaml
sensitive_paths:
  deny:
    - ".env"
    - "*.key"
    - "secrets/"
```

## 反模式列表

| 反模式 | 问题 | 正确做法 |
|--------|------|----------|
| 跳过 proposal | 缺乏设计思考 | 先写 proposal 再实现 |
| 大变更 | 难以审查和回滚 | 拆分成小变更 |
| 无证据任务 | 无法验证完成 | 记录验证命令和结果 |
| 直接编辑 specs | 冲突风险 | 使用增量 specs |
| 文本替换重命名 | 语义漂移 | 使用语义化工具 |
| 无限修复循环 | 浪费时间 | 使用有界循环 |
| 长期分支 | 合并困难 | 频繁合并 |
| 不记录会话 | 知识丢失 | 使用 record-session |
| 提交秘密 | 安全风险 | 使用 .env |
| 跳过门禁 | 质量下降 | 所有门禁必须通过 |

## 每周回顾

### 检查指标

```bash
npm run metrics:report -- --save
npm run workflow:gate
```

### 关注点

1. **Failure Rate 趋势** - 是否有改善
2. **Lead Time** - 变更是否太大
3. **Rework Count** - 需求是否清晰
4. **Spec Drift** - 规格是否同步

### 调优方向

| 指标异常 | 调优方向 |
|----------|----------|
| Failure Rate 高 | 加强测试、收紧 lint |
| Lead Time 长 | 拆分变更、减少范围 |
| Rework 多 | 加强设计评审 |
| Spec Drift | 要求先写 specs |
