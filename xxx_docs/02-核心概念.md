# 核心概念

## Trellis 工作流系统

### 设计理念

Trellis 解决 AI 辅助开发的核心问题：**上下文连续性**。

```
┌─────────────────────────────────────────────────────────┐
│  会话 1                会话 2                会话 3     │
│  ┌─────────┐          ┌─────────┐          ┌─────────┐ │
│  │ 项目知识 │    →     │  ???    │    →     │  ???    │ │
│  └─────────┘          └─────────┘          └─────────┘ │
│                                                         │
│  传统方式：每次会话从零开始                              │
└─────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────┐
│  会话 1                会话 2                会话 3     │
│  ┌─────────┐    读取   ┌─────────┐    读取   ┌─────────┐ │
│  │ 写入    │    ←────  │ 读取    │    ←────  │ 读取    │ │
│  │ journal │           │ journal │           │ journal │ │
│  └─────────┘          └─────────┘          └─────────┘ │
│                                                         │
│  Trellis：通过 workspace 持久化上下文                    │
└─────────────────────────────────────────────────────────┘
```

### 核心命令

| 命令 | 作用 | 触发时机 |
|------|------|----------|
| `/trellis:start` | 恢复项目上下文 | 会话开始时 |
| `/trellis:record-session` | 记录会话成果 | 会话结束时 |
| `/trellis:before-*-dev` | 注入项目规范 | 开发前 |
| `/trellis:check-*` | 验证代码规范 | 开发后 |

### 工作区结构

```
.trellis/workspace/
├── index.md              # 全局进度索引
├── codex/                # Codex 会话记录
└── {owner}/              # 按开发者隔离
    ├── index.md          # 个人进度索引
    └── journal-N.md      # 会话记录（最多 2000 行）
```

## OpenSpec 变更管理

### 设计理念

OpenSpec 解决 AI 辅助开发的另一个问题：**变更可追溯性**。

```
传统方式：
  对话中讨论 → 代码变更 → （无记录）

OpenSpec 方式：
  创建变更 → 编写规格 → 实现 → 验证 → 归档
     ↓          ↓         ↓       ↓       ↓
  openspec/changes/<name>/proposal.md
                        /design.md
                        /tasks.md
                        /specs/
```

### 变更生命周期

```
┌──────────────┐     ┌──────────────┐     ┌──────────────┐
│   创建变更    │ ──→ │   实现阶段    │ ──→ │   归档变更    │
│              │     │              │     │              │
│ proposal.md  │     │ design.md    │     │ 合并到       │
│ (意图)       │     │ tasks.md     │     │ openspec/    │
│              │     │ specs/       │     │ specs/       │
└──────────────┘     └──────────────┘     └──────────────┘
```

### 核心命令

```bash
# 创建变更
openspec new change <name>

# 查看状态
openspec status --change <name>

# 严格验证
openspec validate --all --strict --no-interactive

# 归档变更
openspec archive <name> -y
```

## Policy-as-Code（策略即代码）

### 设计理念

将工作流策略从"口头约定"变为"可执行配置"。

### 配置文件：`.trellis/policy.yaml`

```yaml
# 敏感路径配置
sensitive_paths:
  deny:
    - ".env"
    - "*.key"
    - "secrets/"

# 阈值配置
thresholds:
  verify_failure_rate:
    warn: 0.2
    fail: 0.5
    description: "验证失败率阈值"

  rework_count:
    warn: 3
    fail: 5
    description: "每周返工次数阈值"

  lead_time_p90_hours:
    warn: 24
    fail: 72
    description: "P90 前置时间"

# 会话证据要求
session_evidence:
  required_for_implement: true
  required_fields:
    - "Memory Sources"
    - "Disclosure Level"
    - "Source IDs"
```

### 策略门禁命令

```bash
# 本地策略检查
npm run workflow:policy

# CI 策略检查
npm run workflow:gate -- --ci

# 指标阈值检查
npm run workflow:gate
```

## 可观测性系统

### 6 个核心指标

| 指标 | 含义 | 采集来源 |
|------|------|----------|
| **Lead Time** | 任务从开始到完成的时间 | task-complete 事件 |
| **Verify Failure Rate** | 验证失败率 | verify-loop 事件 |
| **Rework Count** | 返工次数 | rework 事件 |
| **Parallel Throughput** | 并行任务数 | session 事件 |
| **Spec Drift Events** | 规格漂移事件 | spec-drift 事件 |
| **Token Cost** | API 调用成本 | 外部导入 |

### 指标采集

```bash
# 采集指标
npm run metrics:collect

# 生成周报
npm run metrics:report

# 生成最近 4 周报告
npm run metrics:report:last
```

### 指标存储

```
.trellis/metrics/
├── daily/                # 每日指标
│   └── YYYY-MM-DD.jsonl  # JSONL 格式事件流
└── weekly/               # 每周报告
    └── report-YYYY-WNN.md
```

## 质量门禁体系

### 门禁层级

```
┌─────────────────────────────────────────────────────────┐
│                    质量门禁层级                          │
├─────────────────────────────────────────────────────────┤
│  Level 1: verify:fast     快速检查（lint, typecheck）    │
│  Level 2: verify          完整检查（+ test, build）      │
│  Level 3: workflow:policy 策略合规（变更、会话、安全）   │
│  Level 4: workflow:gate   指标阈值（健康度检查）         │
│  Level 5: verify:ci       CI 完整门禁（含 OpenSpec）     │
└─────────────────────────────────────────────────────────┘
```

### 门禁命令

```bash
npm run verify:fast      # 快速（~10s）
npm run verify           # 完整（~30s）
npm run workflow:policy  # 策略
npm run workflow:gate    # 指标
npm run verify:ci        # CI 等价
```

## 失败资产化

### 设计理念

每次失败都是学习机会，应该被系统化记录。

### Gotchas 目录

```
.trellis/gotchas/
├── index.md              # 经验教训索引
└── *.md                  # 具体教训文档
```

### Gotcha 模板

```markdown
# 问题标题

## 现象
描述问题的具体表现

## 根因
分析问题的根本原因

## 解决方案
描述解决方案

## 预防措施
如何避免类似问题再次发生

## 相关文件
- 文件1
- 文件2
```
