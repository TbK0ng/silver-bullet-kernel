# 变更管理

## 变更生命周期

```
┌─────────────────────────────────────────────────────────────────────┐
│                        OpenSpec 变更生命周期                          │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│   ┌──────────┐     ┌──────────┐     ┌──────────┐     ┌──────────┐ │
│   │  创建    │ ──→ │  规划    │ ──→ │  实现    │ ──→ │  归档    │ │
│   │          │     │          │     │          │     │          │ │
│   │ openspec │     │ proposal │     │ tasks    │     │ 合并到   │ │
│   │ new      │     │ design   │     │ specs/   │     │ specs/   │ │
│   │ change   │     │          │     │          │     │          │ │
│   └──────────┘     └──────────┘     └──────────┘     └──────────┘ │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

## 创建变更

### 命令

```bash
openspec new change <name>
```

### 命名规范

- 使用小写字母和连字符
- 描述性名称，如：`add-user-authentication`
- 格式：`<动作>-<对象>[-<限定词>]`

### 生成的目录结构

```
openspec/changes/<name>/
├── proposal.md      # 变更意图和目标
├── design.md        # 技术设计
├── tasks.md         # 任务清单和证据
└── specs/           # 规格增量
```

## 编写变更文档

### proposal.md（意图）

```markdown
# 变更名称

## 目标
一句话描述这个变更要解决什么问题

## 背景
为什么需要这个变更

## 范围
- 包含的内容
- 不包含的内容

## 成功标准
如何判断变更完成
```

### design.md（设计）

```markdown
# 技术设计

## 方案
描述技术实现方案

## 影响范围
列出受影响的文件和模块

## 风险
潜在风险和缓解措施

## 替代方案
考虑过的其他方案
```

### tasks.md（任务）

```markdown
# 任务清单

## 任务列表

| ID | 任务 | 状态 |
|----|------|------|
| T1 | 描述 | pending |
| T2 | 描述 | done |

### Task Evidence

| ID | Status | Files | Action | Verify | Done |
|----|--------|-------|--------|--------|------|
| T1 | done | src/a.ts | 添加功能 | npm run verify:fast | ✅ 通过 |
```

**Task Evidence 必须包含：**
- `Task Evidence` 标题
- `Files`, `Action`, `Verify`, `Done` 列
- 至少一行非空数据

## 实现阶段

### 分支命名

```
sbk-<owner>-<change>
```

示例：`sbk-alice-add-user-authentication`

### Worktree 隔离

```bash
# 创建 worktree
git worktree add ../trellis-worktrees/sbk-alice-add-auth sbk-alice-add-auth

# 在 worktree 中工作
cd ../trellis-worktrees/sbk-alice-add-auth

# 完成后删除 worktree
git worktree remove ../trellis-worktrees/sbk-alice-add-auth
```

### 验证证据

每次提交任务时记录：

| 字段 | 内容 |
|------|------|
| Files | 修改的文件列表 |
| Action | 做了什么 |
| Verify | 运行的验证命令 |
| Done | 客观结果（通过/失败） |

## 归档变更

### 前提条件

- [ ] proposal.md 完整
- [ ] design.md 完整
- [ ] tasks.md 有证据记录
- [ ] `npm run verify` 通过
- [ ] `npm run workflow:policy` 通过

### 归档命令

```bash
# 验证所有规格
openspec validate --all --strict --no-interactive

# 归档
openspec archive <name> -y
```

### 归档后效果

```
openspec/changes/<name>/  →  openspec/changes/archive/<date>-<name>/
                              openspec/specs/ (合并增量)
```

## 变更状态查看

```bash
# 列出所有活跃变更
openspec list

# 查看特定变更状态
openspec status --change <name>

# 输出示例
Change: add-user-authentication
Artifacts: 4/4 complete
  ✅ proposal.md
  ✅ design.md
  ✅ tasks.md
  ✅ specs/user-auth.md
```

## 规格漂移处理

### 什么是规格漂移？

代码与规格不一致的情况：
- 修改了代码但没更新 specs
- specs 描述的功能未实现
- 实现了 specs 未描述的功能

### 检测

```bash
npm run workflow:gate
```

指标 `spec_drift_events` > 0 表示有漂移。

### 修复

1. 在变更中创建 specs 增量
2. 更新 tasks.md 记录规格变更
3. 重新运行验证

## 变更最佳实践

### Do

- ✅ 变更范围小而专注
- ✅ 先写 proposal 再写代码
- ✅ 保持 tasks.md 实时更新
- ✅ 每个任务有明确的验证证据
- ✅ 使用 worktree 隔离并行工作

### Don't

- ❌ 跳过 proposal 直接写代码
- ❌ 同时在多个 change 中工作
- ❌ 在 main worktree 中实现
- ❌ 忘记更新 tasks.md 证据
- ❌ 归档不完整的变更
