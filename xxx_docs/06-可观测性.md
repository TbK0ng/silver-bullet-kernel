# å¯è§‚æµ‹æ€§

## è®¾è®¡ç†å¿µ

å¯è§‚æµ‹æ€§æ˜¯é“¶å¼¹è®¡åˆ’çš„æ ¸å¿ƒç»„ä»¶ä¹‹ä¸€ã€‚é€šè¿‡é‡åŒ–æŒ‡æ ‡ï¼Œæˆ‘ä»¬å¯ä»¥ï¼š

1. **å®¢è§‚è¯„ä¼°** - ç”¨æ•°æ®è¯´è¯ï¼Œè€Œéä¸»è§‚æ„Ÿå—
2. **æŒç»­æ”¹è¿›** - è¯†åˆ«ç“¶é¢ˆï¼Œé’ˆå¯¹æ€§ä¼˜åŒ–
3. **é¢„é˜²é—®é¢˜** - é˜ˆå€¼é¢„è­¦ï¼Œæå‰å¹²é¢„

## 6 ä¸ªæ ¸å¿ƒæŒ‡æ ‡

### 1. Lead Timeï¼ˆå‰ç½®æ—¶é—´ï¼‰

**å®šä¹‰ï¼š** ä»»åŠ¡ä»å¼€å§‹åˆ°å®Œæˆçš„å¹³å‡æ—¶é—´

**é‡‡é›†ï¼š** `task-complete` äº‹ä»¶

**é˜ˆå€¼ï¼š**
- P50 < 8 å°æ—¶ï¼ˆå¥åº·ï¼‰
- P90 < 24 å°æ—¶ï¼ˆè­¦å‘Šï¼‰
- P90 > 72 å°æ—¶ï¼ˆå¤±è´¥ï¼‰

**è§£è¯»ï¼š**
- è¿‡é«˜ â†’ å˜æ›´èŒƒå›´å¤ªå¤§ï¼Œéœ€è¦æ‹†åˆ†
- è¿‡ä½ â†’ å¯èƒ½ä»»åŠ¡ç²’åº¦è¿‡ç»†

### 2. Verify Failure Rateï¼ˆéªŒè¯å¤±è´¥ç‡ï¼‰

**å®šä¹‰ï¼š** éªŒè¯å‘½ä»¤å¤±è´¥çš„æ¯”ä¾‹

**é‡‡é›†ï¼š** `verify-loop` äº‹ä»¶

**é˜ˆå€¼ï¼š**
- < 20%ï¼ˆå¥åº·ï¼‰
- 20%-50%ï¼ˆè­¦å‘Šï¼‰
- > 50%ï¼ˆå¤±è´¥ï¼‰

**è§£è¯»ï¼š**
- è¿‡é«˜ â†’ æµ‹è¯•è¦†ç›–ä¸è¶³æˆ–ä»£ç è´¨é‡é—®é¢˜
- éœ€è¦åˆ†æå¤±è´¥æ­¥éª¤ï¼Œé’ˆå¯¹æ€§æ”¹è¿›

### 3. Rework Countï¼ˆè¿”å·¥æ¬¡æ•°ï¼‰

**å®šä¹‰ï¼š** å·²å®Œæˆä»»åŠ¡éœ€è¦é‡æ–°æ‰“å¼€çš„æ¬¡æ•°

**é‡‡é›†ï¼š** `rework` äº‹ä»¶

**é˜ˆå€¼ï¼š**
- < 3 æ¬¡/å‘¨ï¼ˆå¥åº·ï¼‰
- 3-5 æ¬¡/å‘¨ï¼ˆè­¦å‘Šï¼‰
- > 5 æ¬¡/å‘¨ï¼ˆå¤±è´¥ï¼‰

**è§£è¯»ï¼š**
- è¿‡é«˜ â†’ éœ€æ±‚ä¸æ¸…æ™°æˆ–éªŒæ”¶æ ‡å‡†ä¸æ˜ç¡®
- éœ€è¦åŠ å¼º proposal å’Œ design é˜¶æ®µ

### 4. Parallel Throughputï¼ˆå¹¶è¡Œååé‡ï¼‰

**å®šä¹‰ï¼š** åŒæ—¶è¿›è¡Œçš„æ´»è·ƒå˜æ›´æ•°é‡

**é‡‡é›†ï¼š** `session-start`/`session-end` äº‹ä»¶

**é˜ˆå€¼ï¼š**
- >= 1ï¼ˆå¥åº·ï¼‰
- = 0ï¼ˆè­¦å‘Š/å¤±è´¥ï¼‰

**è§£è¯»ï¼š**
- ä¸º 0 â†’ æœªä½¿ç”¨å¹¶è¡Œèƒ½åŠ›
- è¿‡é«˜ï¼ˆ>3ï¼‰â†’ WIP é™åˆ¶å¯èƒ½éœ€è¦è°ƒæ•´

### 5. Spec Drift Eventsï¼ˆè§„æ ¼æ¼‚ç§»äº‹ä»¶ï¼‰

**å®šä¹‰ï¼š** ä»£ç ä¸è§„æ ¼ä¸ä¸€è‡´çš„äº‹ä»¶æ¬¡æ•°

**é‡‡é›†ï¼š** `spec-drift` äº‹ä»¶

**é˜ˆå€¼ï¼š**
- = 0ï¼ˆå¥åº·ï¼‰
- 1-10ï¼ˆè­¦å‘Šï¼‰
- > 10ï¼ˆå¤±è´¥ï¼‰

**è§£è¯»ï¼š**
- ä»»ä½•éé›¶å€¼éƒ½éœ€è¦ç«‹å³å›å¡«è§„æ ¼
- è§„æ ¼åº”è¯¥åœ¨ä»£ç ä¹‹å‰

### 6. Token Costï¼ˆä»¤ç‰Œæˆæœ¬ï¼‰

**å®šä¹‰ï¼š** API è°ƒç”¨çš„ç´¯è®¡æˆæœ¬

**é‡‡é›†ï¼š** å¤–éƒ¨å¯¼å…¥

**çŠ¶æ€ï¼š**
- availableï¼ˆå·²å¯¼å…¥ï¼‰
- unavailableï¼ˆæœªå¯¼å…¥ï¼‰

## æŒ‡æ ‡é‡‡é›†

### äº‹ä»¶ç±»å‹

| äº‹ä»¶ç±»å‹ | å‘½ä»¤ | é‡‡é›†å†…å®¹ |
|----------|------|----------|
| session-start | è‡ªåŠ¨ï¼ˆhookï¼‰ | ä¼šè¯å¼€å§‹æ—¶é—´ |
| session-end | è‡ªåŠ¨ï¼ˆhookï¼‰ | ä¼šè¯ç»“æŸã€æˆåŠŸ/å¤±è´¥ |
| verify-loop | è‡ªåŠ¨ï¼ˆhookï¼‰ | éªŒè¯å°è¯•ã€æˆåŠŸ/å¤±è´¥ |
| task-complete | æ‰‹åŠ¨ | ä»»åŠ¡å®Œæˆæ—¶é—´ |
| rework | æ‰‹åŠ¨ | è¿”å·¥äº‹ä»¶ |
| spec-drift | æ‰‹åŠ¨ | è§„æ ¼æ¼‚ç§»äº‹ä»¶ |

### é‡‡é›†å‘½ä»¤

```bash
# é‡‡é›†æŒ‡æ ‡ï¼ˆè‡ªåŠ¨èšåˆï¼‰
npm run metrics:collect

# æ‰‹åŠ¨è®°å½•äº‹ä»¶
uv run ./.trellis/scripts/collect_metrics.py session-start
uv run ./.trellis/scripts/collect_metrics.py session-end --success
uv run ./.trellis/scripts/collect_metrics.py verify-loop --success
uv run ./.trellis/scripts/collect_metrics.py task-complete --duration 2.5
uv run ./.trellis/scripts/collect_metrics.py rework --reason "éœ€æ±‚å˜æ›´"
uv run ./.trellis/scripts/collect_metrics.py spec-drift --file src/app.ts
```

### å­˜å‚¨ä½ç½®

```
.trellis/metrics/
â”œâ”€â”€ daily/
â”‚   â””â”€â”€ 2026-02-13.jsonl    # æ¯æ—¥äº‹ä»¶æµ
â””â”€â”€ weekly/
    â””â”€â”€ report-2026-W07.md   # æ¯å‘¨æŠ¥å‘Š
```

## å‘¨æŠ¥ç”Ÿæˆ

### ç”Ÿæˆå‘½ä»¤

```bash
# ç”Ÿæˆå½“å‰å‘¨æŠ¥å‘Š
npm run metrics:report

# ä¿å­˜åˆ°æ–‡ä»¶
npm run metrics:report -- --save

# ç”Ÿæˆæœ€è¿‘ 4 å‘¨æŠ¥å‘Š
npm run metrics:report:last

# ç”ŸæˆæŒ‡å®šå‘¨æŠ¥å‘Š
npm run metrics:report -- --week 2026-W07
```

### æŠ¥å‘Šå†…å®¹

```markdown
# Workflow Weekly Report

**Week**: 2026-W07
**Period**: 2026-02-09 to 2026-02-15

## Summary

| Metric | Value |
|--------|-------|
| Sessions | 15 |
| Success Rate | 93.3% |
| Tasks Completed | 8 |
| Verify Loops | 23 |

## Key Indicators

| # | Indicator | Value | Status |
|---|-----------|-------|--------|
| 1 | Lead Time (avg) | 4.2h | ğŸŸ¢ OK |
| 2 | Verify Failure Rate | 12.5% | ğŸŸ¢ OK |
| 3 | Rework Events | 1 | ğŸŸ¢ OK |
| 4 | Parallel Throughput | 2 concurrent | ğŸŸ¢ OK |
| 5 | Spec Drift Events | 0 | ğŸŸ¢ OK |
| 6 | Token Cost | N/A | âšª N/A |

## Recommendations

- âœ… All indicators are within healthy ranges.
```

## æ¯å‘¨å›é¡¾æµç¨‹

### æ­¥éª¤

```bash
# 1. è¿è¡Œ CI ç­‰ä»·éªŒè¯
npm run verify:ci

# 2. è¿è¡Œå¥åº·æ£€æŸ¥
npm run workflow:doctor

# 3. é‡‡é›†æŒ‡æ ‡
npm run metrics:collect

# 4. ç”ŸæˆæŠ¥å‘Š
npm run metrics:report -- --save

# 5. æ£€æŸ¥æŒ‡æ ‡é—¨ç¦
npm run workflow:gate
```

### å›é¡¾é‡ç‚¹

1. **Lead Time è¶‹åŠ¿** - æ˜¯å¦æœ‰æ”¹å–„æˆ–æ¶åŒ–
2. **Failure Rate** - è¯†åˆ«é«˜é¢‘å¤±è´¥æ­¥éª¤
3. **Rework Pattern** - åˆ†æè¿”å·¥åŸå› 
4. **Drift Events** - ç¡®ä¿è§„æ ¼ä¸ä»£ç åŒæ­¥

## æŒ‡æ ‡è°ƒä¼˜

### å¤±è´¥ç‡é«˜

```
ç°è±¡ï¼šverify_failure_rate > 20%
è¡ŒåŠ¨ï¼š
1. åˆ†æå¤±è´¥æ­¥éª¤åˆ†å¸ƒ
2. åŠ å¼ºæµ‹è¯•è¦†ç›–
3. æ·»åŠ  pre-commit æ£€æŸ¥
4. æ”¶ç´§ verify:fast æ£€æŸ¥
```

### å‰ç½®æ—¶é—´é•¿

```
ç°è±¡ï¼šlead_time_p90 > 24h
è¡ŒåŠ¨ï¼š
1. æ‹†åˆ†å¤§å˜æ›´
2. å‡å°‘å˜æ›´èŒƒå›´
3. æå‰å®Œæˆè®¾è®¡
4. å°½æ—©å½’æ¡£
```

### è¿”å·¥é¢‘ç¹

```
ç°è±¡ï¼šrework_count > 3
è¡ŒåŠ¨ï¼š
1. åŠ å¼º proposal å®¡æŸ¥
2. æ˜ç¡®éªŒæ”¶æ ‡å‡†
3. å¢åŠ è®¾è®¡è¯„å®¡
4. ç»†åŒ–ä»»åŠ¡ç²’åº¦
```

### è§„æ ¼æ¼‚ç§»

```
ç°è±¡ï¼šspec_drift_events > 0
è¡ŒåŠ¨ï¼š
1. ç«‹å³å›å¡«è§„æ ¼
2. è¦æ±‚å…ˆå†™ specs å†å†™ä»£ç 
3. åœ¨ policy ä¸­åŠ å¼ºæ£€æŸ¥
```

## Token æˆæœ¬è¿½è¸ª

### å¯¼å…¥æˆæœ¬æ•°æ®

```bash
npm run metrics:token-cost -- \
  -Source anthropic \
  -TotalCostUsd 12.34 \
  -TotalInputTokens 100000 \
  -TotalOutputTokens 50000
```

### æŸ¥çœ‹çŠ¶æ€

```bash
npm run metrics:collect
npm run workflow:gate
```

**çŠ¶æ€è¯´æ˜ï¼š**
- `available` - å·²å¯¼å…¥æˆæœ¬æ•°æ®
- `unavailable` - æœªå¯¼å…¥ï¼ˆè¶…è¿‡ 2 å‘¨éœ€å…³æ³¨ï¼‰

## Hook è‡ªåŠ¨é‡‡é›†

### session-start.py

è‡ªåŠ¨è®°å½•ä¼šè¯å¼€å§‹äº‹ä»¶ï¼š

```python
# .claude/hooks/session-start.py
def record_session_start_metric():
    subprocess.run([
        "uv", "run", "./.trellis/scripts/collect_metrics.py",
        "session-start"
    ])
```

### ralph-loop.py

è‡ªåŠ¨è®°å½•éªŒè¯å¾ªç¯äº‹ä»¶ï¼š

```python
# .claude/hooks/ralph-loop.py
def record_verify_loop_metric(success: bool):
    subprocess.run([
        "uv", "run", "./.trellis/scripts/collect_metrics.py",
        "verify-loop",
        "--success" if success else "--failure"
    ])
```
