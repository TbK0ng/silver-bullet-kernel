# 多人协作

## 协作原则

### 单一责任

- **一个变更 = 一个负责人**
- 角色在变更之间轮换，不在同一变更内轮换
- 负责人负责从创建到归档的完整生命周期

### 隔离工作

- **一个变更 = 一个分支 = 一个 worktree**
- 本地实现必须在 linked worktree 中进行，不在 main worktree
- 频繁 rebase 到 main

## Worktree 工作流

### 创建 Worktree

```bash
# 语法
git worktree add <path> <branch>

# 示例：为变更 add-auth 创建 worktree
git worktree add ../trellis-worktrees/sbk-alice-add-auth sbk-alice-add-auth
```

### 在 Worktree 中工作

```bash
# 进入 worktree
cd ../trellis-worktrees/sbk-alice-add-auth

# 正常开发流程
npm install
npm run verify:fast

# 开发...
npm run verify
npm run workflow:policy
```

### 清理 Worktree

```bash
# 归档变更后删除 worktree
git worktree remove ../trellis-worktrees/sbk-alice-add-auth

# 或者手动删除
rm -rf ../trellis-worktrees/sbk-alice-add-auth
git worktree prune
```

## 分支命名规范

```
sbk-<owner>-<change>
```

| 部分 | 说明 |
|------|------|
| `sbk-` | 固定前缀（Silver Bullet Kernel） |
| `<owner>` | 变更负责人 |
| `<change>` | 变更名称 |

**示例：**
- `sbk-alice-add-user-auth`
- `sbk-bob-fix-login-bug`
- `sbk-charlie-refactor-api`

## 合并策略

### 小变更：Squash Merge

```bash
# PR 合并时 squash
git merge --squash sbk-alice-add-auth
git commit -m "feat(auth): add user authentication"
```

### 大变更：保留原子提交

```bash
# 保留完整提交历史
git merge sbk-alice-add-auth --no-ff
```

### 合并纪律

- ❌ 永远不要合并未通过门禁的分支
- ❌ 永远不要合并缺少会话证据的分支
- ✅ 会话证据路径必须匹配分支 owner

## 冲突避免

### 规格文件

- ❌ 不要直接编辑 `openspec/specs/**`
- ✅ 使用 `openspec/changes/<name>/specs/**` 增量
- ✅ 通过 `openspec archive` 合并

### 共享模块

- ✅ 在 proposal 中协调共享模块的修改计划
- ✅ 在 tasks 中明确标注共享模块变更
- ✅ 及时沟通冲突风险

### 合并顺序

```
┌──────────────┐     ┌──────────────┐     ┌──────────────┐
│  变更 A      │ ──→ │  变更 B      │ ──→ │  变更 C      │
│  (共享模块)  │     │  (依赖 A)    │     │  (依赖 B)    │
└──────────────┘     └──────────────┘     └──────────────┘
       │                    │                    │
       ▼                    ▼                    ▼
   先归档              等 A 归档后           等 B 归档后
                       再开始               再开始
```

## 会话证据要求

### Owner Scoped

会话证据必须存放在 owner 的目录下：

```
.trellis/workspace/
├── alice/
│   ├── index.md
│   └── journal-1.md
└── bob/
    ├── index.md
    └── journal-1.md
```

### 必需标记

```markdown
## Memory Sources
- .trellis/spec/guides/
- openspec/specs/

## Disclosure Level
- full

## Source IDs
- S001, S003
```

## 协作检查清单

### 开始协作前

- [ ] 确认变更分配（谁是 owner）
- [ ] 创建 compliant 分支名
- [ ] 创建 linked worktree
- [ ] 通知协作者变更范围

### 开发过程中

- [ ] 频繁 rebase main
- [ ] 及时更新 tasks.md
- [ ] 沟通共享模块变更

### 合并前

- [ ] `npm run verify` 通过
- [ ] `npm run workflow:policy` 通过
- [ ] 会话证据完整
- [ ] 代码审查通过

### 合并后

- [ ] 归档 OpenSpec 变更
- [ ] 清理 worktree
- [ ] 更新全局进度索引

## 双人协作 SOP

### 角色分配

| 变更 | Owner | Reviewer |
|------|-------|----------|
| add-auth | Alice | Bob |
| fix-login | Bob | Alice |
| refactor-api | Alice | Bob |

### 日常工作流

```
Alice (Owner)                    Bob (Reviewer)
     │                                │
     │  1. 创建变更                   │
     │  2. 编写 proposal/design       │
     │  3. 实现                       │
     │  4. 提交 PR                    │
     │ ─────────────────────────────→ │
     │                                │  5. 审查
     │                                │  6. 提出意见
     │ ←───────────────────────────── │
     │  7. 修改                       │
     │  8. 请求再次审查               │
     │ ─────────────────────────────→ │
     │                                │  9. 批准
     │ ←───────────────────────────── │
     │  10. 合并                      │
     │  11. 归档                      │
     ▼                                ▼
```
