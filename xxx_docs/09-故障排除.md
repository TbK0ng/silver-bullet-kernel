# 故障排除

## 环境问题

### OpenSpec 命令未找到

**症状：**
```
'openspec' is not recognized as a command
```

**原因：** OpenSpec CLI 未安装或未在 PATH 中

**解决方案：**
```bash
# 全局安装
npm install -g @fission-ai/openspec@latest

# 验证安装
openspec --version
```

### Python 脚本执行失败

**症状：**
```
python3: command not found
或
ModuleNotFoundError: No module named 'yaml'
```

**原因：** Python 环境问题

**解决方案：**
```bash
# 使用 uv 安装依赖
uv sync

# 使用 uv run 执行脚本
uv run ./.trellis/scripts/doctor.py
```

### Node 依赖问题

**症状：**
```
Cannot find module 'xxx'
```

**原因：** node_modules 不完整或版本不匹配

**解决方案：**
```bash
# 清理并重新安装
rm -rf node_modules package-lock.json
npm install
```

## 验证问题

### verify:fast 失败

**症状：**
```
npm run verify:fast → ESLint error / TypeScript error
```

**诊断：**
```bash
# 单独运行检查
npx eslint src/
npx tsc --noEmit
```

**解决方案：**
1. 修复具体的 lint 错误
2. 修复类型错误
3. 重新运行 `npm run verify:fast`

### verify 失败但 verify:fast 通过

**症状：**
```
npm run verify:fast → ✅ 通过
npm run verify → ❌ 失败
```

**可能原因：**
- 测试失败
- 构建失败

**诊断：**
```bash
# 单独运行测试
npm run test

# 单独运行构建
npm run build
```

### 反复验证失败

**症状：**
验证失败，修复后仍然失败

**解决方案：**
```bash
# 使用有界循环收集诊断
npm run verify:loop -- -Profile fast -MaxAttempts 2

# 查看诊断结果
cat .metrics/verify-fix-loop.jsonl
```

## 策略门禁问题

### workflow:policy 失败：无活跃变更

**症状：**
```
No active OpenSpec change found
```

**原因：** 实现修改需要活跃变更

**解决方案：**
```bash
# 创建变更
openspec new change <name>

# 或继续现有变更
openspec status
```

### workflow:policy 失败：任务证据缺失

**症状：**
```
Task evidence schema validation failed
```

**原因：** tasks.md 不符合严格模式

**解决方案：**

确保 tasks.md 包含：
```markdown
### Task Evidence

| ID | Status | Files | Action | Verify | Done |
|----|--------|-------|--------|--------|------|
| T1 | done | src/a.ts | 添加功能 | npm run verify:fast | ✅ 通过 |
```

**检查清单：**
- [ ] 有 `### Task Evidence` 标题
- [ ] 有 `Files`, `Action`, `Verify`, `Done` 列
- [ ] 至少有一行非空数据

### workflow:policy 失败：会话证据缺失

**症状：**
```
Session disclosure markers missing
```

**原因：** journal 文件缺少必需标记

**解决方案：**

在 `.trellis/workspace/<owner>/journal-N.md` 中添加：
```markdown
## Memory Sources
- .trellis/spec/guides/
- openspec/specs/

## Disclosure Level
- full

## Source IDs
- S001, S003
```

### workflow:policy 失败：敏感路径

**症状：**
```
Sensitive path modification detected: .env
```

**原因：** 尝试修改禁止的敏感文件

**解决方案：**
1. 不要直接修改敏感文件
2. 如必须修改，更新 policy.yaml 配置
3. 使用环境变量替代硬编码

### workflow:policy 失败：秘密扫描

**症状：**
```
Secret pattern detected in: xxx_docs/report.md
```

**原因：** 文件包含凭证模式的文本

**解决方案：**
```bash
# 查看具体位置
npm run secret:scan:diff

# 删除或脱敏敏感内容
# 用 <redacted> 替换

# 重新扫描
npm run secret:scan
```

## CI 问题

### CI 失败但本地通过

**症状：**
```
CI: ❌ 失败
Local: ✅ 通过
```

**可能原因：**
1. 本地环境与 CI 不一致
2. CI 使用隔离的遥测路径
3. 本地有未提交的改动

**解决方案：**
```bash
# 本地运行 CI 等价命令
npm run verify:ci

# 检查未提交改动
git status
```

### CI Base Ref 不可用

**症状：**
```
Base ref unavailable or resolves to HEAD
```

**原因：** CI 配置缺少 WORKFLOW_BASE_REF

**解决方案：**

确保 CI 配置：
```yaml
env:
  WORKFLOW_BASE_REF: origin/main  # PR
  # 或
  WORKFLOW_BASE_REF: ${{ github.event.before }}  # push
```

并确保：
```yaml
- uses: actions/checkout@v4
  with:
    fetch-depth: 0  # 完整历史
```

## 指标问题

### workflow:gate 失败：指标超阈值

**症状：**
```
Indicator verify_failure_rate exceeded threshold
```

**解决方案：**
```bash
# 查看详细报告
cat xxx_docs/generated/workflow-indicator-gate.md

# 识别问题指标
# 针对性改进
```

**常见指标调优：**
| 指标 | 行动 |
|------|------|
| failure_rate 高 | 加强测试覆盖 |
| lead_time 长 | 拆分变更 |
| rework 多 | 加强设计评审 |
| spec_drift | 回填规格 |

### Token Cost 显示不可用

**症状：**
```
Token Cost: unavailable
```

**原因：** 未导入成本数据

**解决方案：**
```bash
npm run metrics:token-cost -- \
  -Source anthropic \
  -TotalCostUsd 12.34

npm run metrics:collect
npm run workflow:gate
```

## Worktree 问题

### Worktree 创建失败

**症状：**
```
fatal: 'xxx' is already checked out at 'xxx'
```

**原因：** 分支已在其他 worktree 中检出

**解决方案：**
```bash
# 查看现有 worktree
git worktree list

# 清理不需要的 worktree
git worktree remove <path>
git worktree prune
```

### Worktree 依赖缺失

**症状：**
```
Cannot find module 'xxx'
```

**原因：** 新 worktree 未安装依赖

**解决方案：**
```bash
cd ../trellis-worktrees/sbk-xxx-add-feature
npm install
uv sync
```

## OpenSpec 问题

### OpenSpec 验证失败

**症状：**
```
openspec validate --all --strict --no-interactive → FAIL
```

**诊断：**
```bash
# 查看具体错误
openspec validate --change <name>
```

**常见问题：**
- proposal.md 缺失或格式错误
- design.md 缺失或格式错误
- tasks.md 证据不完整
- specs 格式不正确

### 变更归档失败

**症状：**
```
openspec archive <name> → FAIL
```

**可能原因：**
- 变更未完成（artifacts 不完整）
- specs 有冲突

**解决方案：**
```bash
# 检查变更状态
openspec status --change <name>

# 确保所有 artifacts 完成
# proposal.md, design.md, tasks.md, specs/
```

## 健康检查

### 使用 doctor 诊断

```bash
npm run workflow:doctor
```

**输出位置：**
- `xxx_docs/generated/workflow-doctor.md`
- `xxx_docs/generated/workflow-doctor.json`

**常见检查失败：**

| 检查项 | 失败原因 | 解决方案 |
|--------|----------|----------|
| git_repo | 不在 git 仓库中 | git init |
| developer_identity | 未配置开发者 | 配置 .trellis/.developer |
| python_version | Python 版本过低 | 升级到 3.10+ |
| hooks_configured | hooks 配置错误 | 检查 .claude/settings.json |
| policy_file | policy.yaml 缺失 | 创建配置文件 |

## 快速诊断流程

```
问题发生
    │
    ▼
npm run workflow:doctor  ──→ 查看健康状态
    │
    ▼
npm run verify:fast  ──→ 确认基础验证
    │
    ▼
npm run workflow:policy  ──→ 确认策略合规
    │
    ▼
查看 xxx_docs/generated/  ──→ 详细报告
    │
    ▼
针对性修复
```
