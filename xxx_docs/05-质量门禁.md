# 质量门禁

## 门禁层级

```
┌─────────────────────────────────────────────────────────────────────┐
│                        质量门禁金字塔                                │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│                         ┌─────────────┐                             │
│                         │ verify:ci   │  CI 完整门禁                │
│                         └─────────────┘                             │
│                       ┌───────────────────┐                         │
│                       │ workflow:gate     │  指标阈值               │
│                       └───────────────────┘                         │
│                     ┌───────────────────────┐                       │
│                     │ workflow:policy       │  策略合规             │
│                     └───────────────────────┘                       │
│                   ┌───────────────────────────┐                     │
│                   │ verify                    │  完整验证           │
│                   └───────────────────────────┘                     │
│                 ┌───────────────────────────────┐                   │
│                 │ verify:fast                  │  快速验证          │
│                 └───────────────────────────────┘                   │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

## 验证命令

### verify:fast（快速验证）

```bash
npm run verify:fast
```

**检查内容：**
- ESLint 代码检查
- TypeScript 类型检查

**耗时：** ~10 秒

**使用时机：** 每次代码改动后

### verify（完整验证）

```bash
npm run verify
```

**检查内容：**
- ESLint 代码检查
- TypeScript 类型检查
- 单元测试
- 构建

**耗时：** ~30 秒

**使用时机：** 提交前

### verify:ci（CI 验证）

```bash
npm run verify:ci
```

**检查内容：**
- 所有 verify 内容
- OpenSpec 严格验证
- 策略门禁
- 指标门禁

**使用时机：** PR 创建前、CI 流水线

## 策略门禁

### workflow:policy

```bash
npm run workflow:policy
```

**检查内容：**

| 检查项 | 说明 |
|--------|------|
| 敏感路径 | 不允许修改 .env、*.key 等 |
| 秘密扫描 | 持久化文件不含凭证模式 |
| 变更存在 | 实现修改需要活跃变更 |
| 任务证据 | tasks.md 符合严格模式 |
| 会话证据 | journal 包含必要标记 |
| 调度器边界 | dispatch.md 不含写工具 |

**输出：**
- `xxx_docs/generated/workflow-policy-gate.md`
- `xxx_docs/generated/workflow-policy-gate.json`

### workflow:gate

```bash
npm run workflow:gate
```

**检查内容：**

| 指标 | 警告阈值 | 失败阈值 |
|------|----------|----------|
| verify_failure_rate | 20% | 50% |
| rework_count | 3 | 5 |
| lead_time_p90_hours | 24h | 72h |
| spec_drift_events | 3 | 10 |
| parallel_throughput | 1 | 0 |

**输出：**
- `xxx_docs/generated/workflow-indicator-gate.md`
- `xxx_docs/generated/workflow-indicator-gate.json`

## CI 流水线

### GitHub Actions 配置

`.github/workflows/ci.yml` 执行：

1. 安装依赖
2. 安装 OpenSpec CLI
3. 运行 `verify:ci`
4. 执行策略门禁和指标门禁

### CI 行为

- **失败即阻止合并**
- 使用隔离的遥测路径，避免本地污染
- 需要 `WORKFLOW_BASE_REF` 环境变量

### CI 注意事项

```yaml
# 必须配置
fetch-depth: 0  # 完整历史

env:
  WORKFLOW_BASE_REF: ${{ github.event.before }}  # push 事件
  # 或
  WORKFLOW_BASE_REF: origin/main  # PR 事件
```

## 有界验证循环

### 使用场景

当验证反复失败时，使用有界循环收集诊断信息。

### 命令

```bash
npm run verify:loop -- -Profile fast -MaxAttempts 2
```

**参数：**
- `-Profile`: fast 或 full
- `-MaxAttempts`: 最大尝试次数

**输出：**
- `.metrics/verify-fix-loop.jsonl`

### 输出示例

```json
{
  "timestamp": "2026-02-13T10:00:00Z",
  "attempt": 1,
  "profile": "fast",
  "result": "fail",
  "diagnostics": "ESLint error in src/app.ts:42"
}
```

## 健康检查

### workflow:doctor

```bash
npm run workflow:doctor
```

**检查项：**

| ID | 检查项 | 严重程度 |
|----|--------|----------|
| git_repo | Git 仓库存在 | 关键 |
| developer_identity | 开发者身份配置 | 关键 |
| trellis_structure | Trellis 目录结构 | 重要 |
| openspec_structure | OpenSpec 目录结构 | 重要 |
| policy_file | policy.yaml 存在 | 重要 |
| secret_baseline | 秘密扫描基线 | 重要 |
| python_version | Python 版本 | 重要 |
| hooks_configured | 钩子配置 | 重要 |
| workspace_directory | 工作区目录 | 一般 |
| tasks_directory | 任务目录 | 一般 |
| metrics_directory | 指标目录 | 一般 |
| gotchas_directory | 经验目录 | 一般 |

**输出：**
- 控制台输出
- `xxx_docs/generated/workflow-doctor.md`
- `xxx_docs/generated/workflow-doctor.json`

### JSON 输出

```bash
npm run workflow:doctor:json
```

## 任务证据模式

### 必需格式

```markdown
### Task Evidence

| ID | Status | Files | Action | Verify | Done |
|----|--------|-------|--------|--------|------|
| T1 | done | src/a.ts | 添加验证 | npm run verify:fast | ✅ 通过 |
| T2 | pending | - | - | - | - |
```

### 必需元素

- `### Task Evidence` 标题（精确匹配）
- 列：`Files`, `Action`, `Verify`, `Done`
- 至少一行非空数据

### 粒度限制

在 `.trellis/policy.yaml` 中配置：

```yaml
task_evidence:
  max_files_per_row: 5      # 每行最多 5 个文件
  max_action_length: 200    # 动作描述最多 200 字符
```

## 秘密扫描

### 扫描命令

```bash
# 扫描暂存文件
npm run secret:scan

# 扫描差异
npm run secret:scan:diff

# 更新基线
npm run secret:baseline
```

### 检测模式

- API Key 模式
- 密码模式
- 令牌模式
- 私钥模式
- AWS 密钥
- GitHub Token

### 处理检测到的秘密

1. **不要提交** - 立即停止
2. **删除或脱敏** - 使用占位符替换
3. **重新生成** - 如已泄露，重新生成凭证
4. **更新基线** - 如果是误报

## 门禁失败处理

### 常见失败原因

| 门禁 | 常见原因 | 解决方案 |
|------|----------|----------|
| verify:fast | lint/type 错误 | 修复错误 |
| verify | 测试失败 | 修复测试 |
| workflow:policy | 无活跃变更 | 创建变更 |
| workflow:policy | 任务证据缺失 | 更新 tasks.md |
| workflow:policy | 敏感路径 | 移动文件或更新策略 |
| workflow:gate | 指标超阈值 | 改善工作流健康度 |

### 诊断流程

1. 查看输出文件（`xxx_docs/generated/`）
2. 定位具体失败项
3. 按建议修复
4. 重新运行门禁
