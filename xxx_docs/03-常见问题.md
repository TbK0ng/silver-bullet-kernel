# 常见问题

## 环境问题

### `openspec: command not found`

**原因：** 没装 OpenSpec CLI

**解决：**
```bash
npm install -g @fission-ai/openspec@latest
```

### `python3: command not found` 或 `ModuleNotFoundError`

**原因：** Python 环境问题

**解决：**
```bash
# 用 uv 安装依赖
uv sync

# 用 uv run 执行
uv run ./.trellis/scripts/doctor.py
```

### `Cannot find module 'xxx'`

**原因：** 依赖没装或版本不对

**解决：**
```bash
rm -rf node_modules package-lock.json
npm install
```

---

## 验证问题

### verify:fast 失败

**诊断：**
```bash
# 单独跑看看
npx eslint src/
npx tsc --noEmit
```

**解决：** 修复报错的具体问题

### verify 失败但 verify:fast 通过

**原因：** 测试或构建失败

**诊断：**
```bash
npm run test
npm run build
```

### 反复失败

**解决：** 用有界循环收集诊断
```bash
npm run verify:loop -- -Profile fast -MaxAttempts 2
cat .metrics/verify-fix-loop.jsonl
```

---

## 策略门禁问题

### "No active OpenSpec change found"

**原因：** 改了代码但没有对应的变更记录

**解决：**
```bash
# 创建变更
openspec new change <name>

# 然后再跑
npm run workflow:policy
```

### "Task evidence schema validation failed"

**原因：** tasks.md 格式不对

**解决：** 确保有这些内容

```markdown
### Task Evidence

| ID | Status | Files | Action | Verify | Done |
|----|--------|-------|--------|--------|------|
| T1 | done | src/a.ts | 添加功能 | npm run verify:fast | ✅ |
```

**检查：**
- [ ] 有 `### Task Evidence` 标题
- [ ] 列包含 Files, Action, Verify, Done
- [ ] 至少一行数据

### "Session disclosure markers missing"

**原因：** journal 文件缺标记

**解决：** 在 `.trellis/workspace/<owner>/journal-N.md` 加

```markdown
## Memory Sources
- .trellis/spec/guides/

## Disclosure Level
- full

## Source IDs
- S001
```

### "Secret pattern detected"

**原因：** 代码里有疑似密钥的字符串

**解决：**
```bash
# 看具体位置
npm run secret:scan:diff

# 删除或替换成占位符
# 比如 <API_KEY>

# 重扫
npm run secret:scan
```

### "Sensitive path modification detected"

**原因：** 改了 .env 等禁止文件

**解决：**
- 别直接改敏感文件
- 如必须改，更新 policy.yaml

---

## CI 问题

### CI 失败但本地通过

**可能原因：**
1. 环境不一致
2. 有未提交的改动

**解决：**
```bash
# 本地跑 CI 等价命令
npm run verify:ci

# 检查未提交
git status
```

### "Base ref unavailable"

**原因：** CI 配置问题

**解决：** 确保 CI 配置了

```yaml
env:
  WORKFLOW_BASE_REF: origin/main
```

并且

```yaml
- uses: actions/checkout@v4
  with:
    fetch-depth: 0
```

---

## Worktree 问题

### 创建失败 "already checked out"

**解决：**
```bash
# 看看现有的
git worktree list

# 清理不用的
git worktree remove <path>
git worktree prune
```

### 依赖缺失

**解决：**
```bash
cd ../worktrees/sbk-xxx-feature
npm install
uv sync
```

---

## OpenSpec 问题

### 验证失败

**诊断：**
```bash
openspec validate --change <name>
```

**常见问题：**
- proposal.md 缺失
- design.md 缺失
- tasks.md 证据不完整

### 归档失败

**诊断：**
```bash
openspec status --change <name>
```

**解决：** 确保所有 artifacts 完成（proposal, design, tasks, specs）

---

## 指标问题

### 指标超阈值

**诊断：**
```bash
cat xxx_docs/generated/workflow-indicator-gate.md
```

**常见调优：**

| 指标高 | 行动 |
|--------|------|
| 失败率 | 加测试、修 lint |
| 返工 | 加强设计审查 |
| 前置时间 | 拆小变更 |

### Token Cost 显示 unavailable

**解决：**
```bash
npm run metrics:token-cost -- \
  -Source manual \
  -TotalCostUsd 12.34

npm run metrics:collect
npm run workflow:gate
```

---

## 诊断流程

```
遇到问题
    ↓
npm run workflow:doctor  → 看健康状态
    ↓
npm run verify:fast      → 确认基础验证
    ↓
npm run workflow:policy  → 确认策略合规
    ↓
看 xxx_docs/generated/   → 详细报告
    ↓
针对性修复
```

---

## 找不到答案？

1. 看健康检查：`npm run workflow:doctor`
2. 看策略报告：`cat xxx_docs/generated/workflow-policy-gate.md`
3. 看指标报告：`cat xxx_docs/generated/workflow-indicator-gate.md`
