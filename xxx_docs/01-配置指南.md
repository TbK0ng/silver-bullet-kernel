# 配置指南

## policy.yaml 详解

主配置文件：`.trellis/policy.yaml`

### 敏感路径配置

```yaml
sensitive_paths:
  deny:                      # 禁止修改
    - ".env"
    - "*.key"
    - "secrets/"
  warn:                      # 修改时警告
    - "config/*.local.*"
```

### 阈值配置

```yaml
thresholds:
  verify_failure_rate:       # 验证失败率
    warn: 0.2                # 20% 警告
    fail: 0.5                # 50% 失败

  rework_count:              # 每周返工次数
    warn: 3
    fail: 5

  lead_time_p90_hours:       # P90 任务时长
    warn: 24                 # 24 小时警告
    fail: 72                 # 72 小时失败

  parallel_throughput_min:   # 并行任务数
    warn: 1                  # 小于 1 警告
    fail: -1                 # -1 表示永不失败
```

### 会话证据配置

```yaml
session_evidence:
  required_for_implement: true
  required_fields:
    - "Memory Sources"       # 使用的记忆源
    - "Disclosure Level"     # 披露级别
    - "Source IDs"           # 来源 ID
```

### 秘密扫描配置

```yaml
secret_scan:
  enabled: true
  baseline_file: ".secrets.baseline"
  exclude_paths:
    - "node_modules/"
    - ".venv/"
  custom_patterns:
    - name: "API Key"
      pattern: "sk-[a-zA-Z0-9]{20,}"
      severity: "high"
```

### 指标采集配置

```yaml
metrics:
  collection:
    on_session_start: true
    on_session_end: true
    on_verify_loop: true
    on_task_complete: true
  reports:
    weekly_enabled: true
    output_dir: ".trellis/metrics/weekly"
```

## 会话记录配置

### 开发者身份

文件：`.trellis/.developer/<name>.yaml`

```yaml
name: your-name
email: your-email@example.com
```

### 会话日志

位置：`.trellis/workspace/<owner>/journal-N.md`

格式：
```markdown
# 会话记录 2026-02-13

## 完成的工作
- 添加了登录功能
- 修复了验证失败

## 遇到的问题
- ...

## 下一步
- ...

## Memory Sources
- .trellis/spec/guides/

## Disclosure Level
- full

## Source IDs
- S001
```

## Git Worktree 配置

文件：`.trellis/worktree.yaml`

```yaml
post_create:
  - "npm install"
  - "npm run verify:fast"
```

创建 worktree：
```bash
git worktree add ../worktrees/sbk-yourname-add-feature sbk-yourname-add-feature
```

## Claude Hooks 配置

文件：`.claude/settings.json`

```json
{
  "hooks": {
    "SessionStart": [{
      "matcher": "startup",
      "hooks": [{
        "type": "command",
        "command": "uv run .claude/hooks/session-start.py",
        "timeout": 10
      }]
    }],
    "SubagentStop": [{
      "matcher": "check",
      "hooks": [{
        "type": "command",
        "command": "uv run .claude/hooks/ralph-loop.py",
        "timeout": 10
      }]
    }]
  }
}
```

## OpenSpec 配置

### 变更目录结构

```
openspec/changes/<name>/
├── proposal.md    # 必需：为什么要做
├── design.md      # 必需：怎么做
├── tasks.md       # 必需：具体任务
└── specs/         # 可选：规格增量
```

### tasks.md 格式

```markdown
# 任务清单

## 任务

| ID | 任务 | 状态 |
|----|------|------|
| T1 | 添加登录 API | done |
| T2 | 添加测试 | pending |

### Task Evidence

| ID | Status | Files | Action | Verify | Done |
|----|--------|-------|--------|--------|------|
| T1 | done | src/auth.ts | 添加 API | npm run verify:fast | ✅ |
```

**必需：**
- `### Task Evidence` 标题
- `Files`, `Action`, `Verify`, `Done` 列
- 至少一行数据
