# 命令参考

## 验证命令

### `npm run verify:fast`

快速验证，适合频繁运行。

**检查内容：**
- ESLint 代码检查
- TypeScript 类型检查

**耗时：** 约 10 秒

**使用时机：** 每次代码改动后

---

### `npm run verify`

完整验证。

**检查内容：**
- ESLint + TypeScript
- 单元测试
- 构建

**耗时：** 约 30 秒

**使用时机：** 提交前

---

### `npm run verify:ci`

CI 完整验证。

**检查内容：**
- 所有 verify 内容
- OpenSpec 严格验证
- 策略门禁

**使用时机：** PR 创建前

---

### `npm run verify:loop`

有界验证循环，反复失败时用。

```bash
npm run verify:loop -- -Profile fast -MaxAttempts 2
```

**参数：**
- `-Profile`: fast 或 full
- `-MaxAttempts`: 最多尝试几次

**输出：** `.metrics/verify-fix-loop.jsonl`

---

## 工作流命令

### `npm run workflow:doctor`

健康检查，诊断环境问题。

**检查项：**
- Git 仓库
- 开发者身份
- 目录结构
- Python 版本
- 依赖安装

**输出：** 控制台 + `xxx_docs/generated/workflow-doctor.md`

---

### `npm run workflow:policy`

策略门禁检查。

**检查内容：**
- 敏感路径是否被修改
- 是否有活跃变更
- 任务证据是否完整
- 会话证据是否完整
- 代码中是否有密钥

**输出：** `xxx_docs/generated/workflow-policy-gate.md`

---

### `npm run workflow:gate`

指标门禁检查。

**检查内容：**
- 验证失败率是否超阈值
- 返工次数是否超阈值
- 前置时间是否超阈值
- 其他指标

**输出：** `xxx_docs/generated/workflow-indicator-gate.md`

---

## 指标命令

### `npm run metrics:collect`

采集和聚合指标。

**数据来源：** `.trellis/metrics/daily/*.jsonl`

**输出：** 聚合结果到控制台

---

### `npm run metrics:report`

生成周报。

```bash
npm run metrics:report           # 当前周
npm run metrics:report -- --save # 保存到文件
npm run metrics:report -- --week 2026-W07  # 指定周
npm run metrics:report:last      # 最近 4 周
```

**输出：** `.trellis/metrics/weekly/report-YYYY-WNN.md`

---

## 安全命令

### `npm run secret:scan`

扫描暂存文件中的密钥。

```bash
npm run secret:scan              # 扫描 git add 的文件
npm run secret:scan:diff         # 扫描与 main 的差异
npm run secret:baseline          # 更新基线
```

**检测模式：**
- API Key (sk-xxx)
- 密码字段
- Token
- 私钥
- AWS 密钥
- GitHub Token

---

## OpenSpec 命令

### 创建和管理变更

```bash
# 创建变更
openspec new change <name>

# 查看所有活跃变更
openspec list

# 查看特定变更状态
openspec status --change <name>

# 严格验证
openspec validate --all --strict --no-interactive

# 归档
openspec archive <name> -y
```

---

## Claude 命令

在 Claude Code 中使用：

```
/trellis:start          # 开始会话，恢复上下文
/trellis:record-session # 结束会话，保存记录
```

---

## 其他命令

### `npm run dev`

启动开发服务器（示例应用）。

### `npm run demo:smoke`

运行示例应用的冒烟测试。

### `npm run refactor:rename`

语义化重命名（比文本替换安全）。

```bash
npm run refactor:rename -- \
  --file src/app.ts \
  --line 42 \
  --column 7 \
  --newName newFunctionName \
  --dryRun
```

### `npm run memory:context`

渐进式记忆检索。

```bash
npm run memory:context -- -Stage index
npm run memory:context -- -Stage detail -Ids S001,S003
```

### `npm run map:codebase`

生成代码库地图。

**输出：** `xxx_docs/generated/codebase-map.md`
