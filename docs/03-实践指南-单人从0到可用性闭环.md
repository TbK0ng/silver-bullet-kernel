# 实践指南：单人从 0 到可用性闭环

这份指南默认你是项目 owner，目标是在本地完整走通一次“变更 -> 验证 -> 治理 -> 归档”闭环。

## 0. 目标与成功标准

你要达成的不是“代码能跑”，而是同时满足：

1. 功能正确。
2. 流程合规。
3. 证据可追溯。

最终成功信号：

- `npm run verify` 通过。
- `npm run metrics:collect` 和 `npm run workflow:gate` 可运行。
- `npm run workflow:doctor` 健康。
- active change 的 `tasks.md` 有完整 Task Evidence。

## 1. 环境准备

## 1.1 安装依赖

```powershell
npm install
```

如果你还没装 OpenSpec CLI：

```powershell
npm install -g @fission-ai/openspec@latest
```

## 1.2 做一次体检

```powershell
npm run workflow:doctor
```

如果失败，优先修复 doctor 给出的第一条失败项，再重跑。

## 2. 创建并进入规范分支

策略要求分支名满足 `sbk-<owner>-<change>`。  
下面用 `owner=alice`、`change=add-task-priority` 示例。
实际执行时请将 `add-task-priority` 替换为你自己的 change slug（例如 `practice-guides-suite`）。
`..\trellis-worktrees\...` 是相对主仓库的兄弟目录示例，实际以 `.trellis/worktree.yaml` 的 `worktree_dir` 配置为准。

```powershell
git switch main
git pull --ff-only
git branch sbk-alice-add-task-priority
git worktree add ..\trellis-worktrees\sbk-alice-add-task-priority sbk-alice-add-task-priority
cd ..\trellis-worktrees\sbk-alice-add-task-priority
npm install
```

检查你是否在 linked worktree：

```powershell
git rev-parse --git-dir
```

输出路径应包含 `.git/worktrees/`。

## 3. 创建 OpenSpec 变更包

```powershell
openspec new change <change>
```

然后最少补齐：

- `openspec/changes/<change>/proposal.md`
- `openspec/changes/<change>/design.md`
- `openspec/changes/<change>/tasks.md`
- `openspec/changes/<change>/specs/<capability>/spec.md`

注意：分支里的 `<change>` 必须和 active change 一致，否则 policy gate 会失败。

## 4. 按任务实现功能

建议节奏：

1. 每完成一个小任务，先跑 `verify:fast`。
2. 出错就地修，不累积技术债。
3. 在 `tasks.md` 的 `Task Evidence` 表记录：
   - 改了哪些文件
   - 做了什么
   - 用什么命令验证
   - 结果是什么

`Task Evidence` 最小模板：

```markdown
### Task Evidence

| ID | Status | Files | Action | Verify | Done |
| --- | --- | --- | --- | --- | --- |
| 1.1 | [x] | `src/app.ts`, `tests/e2e/app.e2e.test.ts` | Add task priority field and validation | `npm run verify:fast` | API and tests pass locally. |
```

## 5. 执行验证闭环

## 5.1 快速门禁

```powershell
npm run verify:fast
```

通过后再继续。

## 5.2 完整门禁

```powershell
npm run verify
```

如果失败且你短时间内无法定位，启动有界循环：

```powershell
npm run verify:loop -- -Profile fast -MaxAttempts 2
```

查看失败证据：

```powershell
Get-Content .metrics\verify-fix-loop.jsonl
```

## 5.3 可用性冒烟

```powershell
npm run demo:smoke
```

## 6. 采集指标并检查阈值

```powershell
npm run metrics:collect
npm run workflow:gate
```

查看最新快照：

```powershell
Get-Content .metrics\workflow-metrics-latest.json
Get-Content .metrics\workflow-indicator-gate.md
```

## 7. 会话证据记录（避免“只存在对话里”）

在 `.trellis/workspace/<owner>/journal-*.md` 添加本次会话摘要，并包含：

```markdown
## Memory Sources
- .trellis/spec/guides/constitution.md
- openspec/changes/<change>/tasks.md

## Disclosure Level
- full

## Source IDs
- S001
- S004
```

缺少这些标记会触发 policy gate 失败。

## 8. 提交前最终检查

按顺序执行：

```powershell
npm run verify
npm run workflow:doctor
git status
```

理想状态：

- verify 通过
- doctor 健康
- 只包含本次变更相关文件

## 9. 归档与收尾

当变更完成并准备并回主线：

```powershell
openspec archive <change> -y
```

归档完成后再做一次验证，确认归档没有引入漂移：

```powershell
npm run verify:fast
```

## 10. 这套流程为什么有效

单人开发最常见问题是“速度快但不可复盘”。  
这套流程的价值在于：

1. 每一步都有证据文件。
2. 失败可诊断而不是凭记忆回想。
3. 人离开会话后，下一次仍可恢复上下文。

这就是从“能写代码”到“可持续交付”的关键跃迁。
