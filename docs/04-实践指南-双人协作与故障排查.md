# 实践指南：双人协作与故障排查

本指南面向两人并行协作（你 + 朋友）的真实场景。  
目标是“并行提速，但不互相污染”。

## 1. 协作模型（强约束版）

先定 4 条规则：

1. 一个 change 只允许一个 owner 负责实现。
2. 一个 change 对应一个 branch 和一个 worktree。
3. 两人不要并行修改同一个 active change。
4. Canonical specs（`openspec/specs/`）通过 archive 流程合并，不直接并行改。

## 2. 命名与目录约定

分支命名：

- `sbk-<owner>-<change>`
- 示例：`sbk-alice-add-task-priority`（`<owner>`、`<change>` 需替换为你的实际值）

工作树目录建议：

- `..\trellis-worktrees\sbk-<owner>-<change>`
- 该路径通常是“主仓库同级目录”示例，实际以 `.trellis/worktree.yaml` 的 `worktree_dir` 配置为准。

会话证据目录：

- `.trellis/workspace/<owner>/`

## 3. 每日协作 SOP（建议照抄执行）

## 3.1 开工前（两人都做）

```powershell
git switch main
git pull --ff-only
npm run verify:fast
```

## 3.2 开新任务（owner 做）

```powershell
git branch sbk-<owner>-<change>
git worktree add ..\trellis-worktrees\sbk-<owner>-<change> sbk-<owner>-<change>
cd ..\trellis-worktrees\sbk-<owner>-<change>
openspec new change <change>
```

## 3.3 实现中（owner）

- 小步提交前反复跑 `npm run verify:fast`。
- 每完成一个任务，更新 `tasks.md` 的 Task Evidence。

## 3.4 审查中（reviewer）

- 只 review owner 分支，不直接在其 worktree 改代码。
- 关注重点：
  - Task Evidence 是否真实可验。
  - 变更是否超出 proposal/design 范围。
  - 是否有会话证据与披露标记。

## 4. 合并策略（简单可靠）

小改动建议：

- squash merge，保持主线简洁。

较大改动建议：

- 保留原子 commit，方便 bisect 与回滚。

统一要求：

- 合并前至少通过 `npm run verify`。
- 复杂场景建议补跑 `npm run verify:ci`。

## 5. 高发故障与标准修复

下面是最常见失败信号及处理动作。

## 5.1 分支名不合规

现象：

- policy gate 报分支不匹配模式。

修复：

```powershell
git branch -m sbk-<owner>-<change>
```

## 5.2 分支 `<change>` 与 active change 不一致

现象：

- 报 `Branch change id matches active change` 失败。

修复：

1. 要么重命名分支。
2. 要么使用与分支一致的 change 包名。

## 5.3 在主工作树改了实现文件

现象：

- 报“Local implementation runs from linked worktree”失败。

修复：

```powershell
git worktree add ..\trellis-worktrees\sbk-<owner>-<change> sbk-<owner>-<change>
```

切到 linked worktree 再开发。

## 5.4 `tasks.md` 证据表不合规

现象：

- `tasks evidence schema` 失败。

修复：

1. 确保存在标题 `### Task Evidence`。
2. 确保列包含 `Files/Action/Verify/Done`。
3. 确保至少一行非空数据。

## 5.5 会话证据缺失或披露标记缺失

现象：

- session evidence 或 disclosure metadata 相关检查失败。

修复：

在 `.trellis/workspace/<owner>/journal-*.md` 补齐：

- `Memory Sources`
- `Disclosure Level`
- `Source IDs`

## 5.6 指标门禁报 “metrics snapshot missing”

现象：

- `workflow:gate` 报缺少指标快照文件。

修复：

```powershell
npm run metrics:collect
npm run workflow:gate
```

## 5.7 Secret pattern 命中

现象：

- policy gate 报 durable artifact 含敏感模式。

修复：

```powershell
npm run secret:scan:diff
```

按报告定位并打码，然后重跑验证。

## 5.8 反复失败不知道先修哪

标准流程：

```powershell
npm run workflow:doctor
npm run verify:loop -- -Profile fast -MaxAttempts 2
```

先看 `.metrics/workflow-doctor.md`，再看（执行过 `verify:loop` 后生成的）`.metrics/verify-fix-loop.jsonl`。

## 6. 一条底线：不要把“并行”做成“互相覆盖”

两人协作真正的效率来自“隔离 + 证据”，不是同时在同一堆文件里改。  
遵守本指南，你可以做到：

1. 任务并行推进。
2. 问题可快速归因到 owner/change。
3. 合并时冲突和返工显著降低。
