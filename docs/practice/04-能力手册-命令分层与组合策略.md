# 能力手册：命令分层与组合策略

这篇是“字典 + 组合手册”。  
你不需要背命令，只要先找场景，再套组合。

---

## 1. SBK 命令分层（先看这一张）

### L0 统一入口层

- `sbk`：统一命令入口（对应 `scripts/sbk.ps1`）。

### L1 接入与初始化层

- `sbk install` / `sbk upgrade`
- `sbk greenfield`
- `sbk init`
- `sbk capabilities`

### L2 流程编排层

- `sbk flow run`
- `sbk blueprint ...`
- `sbk intake ...`
- `sbk adapter ...`
- `sbk semantic ...`
- `sbk fleet ...`

### L3 验证与门禁层

- `sbk verify:fast`
- `sbk verify`
- `sbk verify:ci`
- `sbk verify:loop`
- `sbk policy`
- `sbk docs-sync`
- `sbk skill-parity`
- `sbk doctor`

### L4 指标与治理层

- `sbk memory:context`
- `sbk metrics:collect`

### L5 规格生命周期层

- `sbk new-change`
- `sbk explore`
- `sbk migrate-specs`
- `sbk parallel ...`
- `sbk record-session`

---

## 2. 命令族速用（按“什么时候用”）

## 2.1 install / upgrade

### 什么时候用

- 首次把 SBK 分发到目标仓：`install`
- 已接入仓升级内核文件：`upgrade`

### 手动命令

```powershell
sbk install --target-repo-root <repo> --preset minimal --channel stable
sbk upgrade --target-repo-root <repo> --preset full --channel stable
```

### 关键差异

- `install` 默认不覆盖已有文件。
- `upgrade` 默认覆盖（等价于 install + overwrite）。

### 主要产物

- `<repo>/.sbk/release-manifest.json`
- `<repo>/.metrics/channel-rollout-audit.jsonl`

---

## 2.2 greenfield

### 什么时候用

- 新项目从 0 起步，需要直接生成规划骨架和最小语言脚手架。

### 手动命令

```powershell
sbk greenfield --adapter node-ts --project-name demo --project-type backend --target-repo-root .
```

### 主要产物

- `PROJECT.md`, `REQUIREMENTS.md`, `ROADMAP.md`, `STATE.md`, `CONTEXT.md`
- `.planning/research/.gitkeep`

---

## 2.3 flow run

### 什么时候用

- 你想“一条命令串起 install/blueprint/intake/verify/fleet”。
- 团队要标准化执行顺序，减少人工漏步骤。

### 手动命令

```powershell
sbk flow run --scenario auto --decision-mode auto --channel stable --target-repo-root .
```

常用参数：

- `--decision-mode auto|ask`
- `--scenario auto|greenfield|brownfield`
- `--with-install`
- `--skip-verify`
- `--fleet-roots <a,b,c>`

### 主要产物

- `.metrics/flow-run-report.json`
- `.metrics/flow-run-report.md`

---

## 2.4 blueprint

### 什么时候用

- 你要快速落地“可上线基线”（CI、安全、runbook、架构模板）。

### 手动命令

```powershell
sbk blueprint list
sbk blueprint apply --name api-service --target-repo-root . --project-name demo --adapter node-ts
sbk blueprint verify --target-repo-root .
```

### 注意

- Beta 蓝图需要显式 `--allow-beta`。
- 已有目标文件冲突时用 `--force`。

---

## 2.5 intake

### 什么时候用

- 存量项目接管，先评估风险再推进。

### 手动命令

```powershell
sbk intake analyze --target-repo-root .
sbk intake plan --target-repo-root .
sbk intake verify --target-repo-root . --profile strict
```

### 主要产物

- `.metrics/intake-risk-profile.json`
- `.metrics/intake-hardening-plan.json`
- `.metrics/intake-readiness.json`

---

## 2.6 adapter

### 什么时候用

- 你要确认/扩展语言生态适配能力。

### 手动命令

```powershell
sbk adapter list
sbk adapter validate --path <adapter-pack>
sbk adapter register --path <adapter-pack>
sbk adapter doctor --target-repo-root .
```

### 主要产物

- `.metrics/adapter-validate-<name>.json`
- `.metrics/adapter-doctor.json`

---

## 2.7 semantic

### 什么时候用

- 做“低风险重命名”“引用追踪”“删除前影响评估”。

### 手动命令

```powershell
sbk semantic rename --file src/app.ts --line 10 --column 8 --new-name NewName --dry-run --target-repo-root .
sbk semantic reference-map --file src/app.ts --line 10 --column 8 --max-results 200 --target-repo-root .
sbk semantic safe-delete-candidates --file src/app.ts --line 10 --column 8 --max-results 200 --target-repo-root .
```

### 主要产物

- `.metrics/semantic-operation-report.json`
- `.metrics/semantic-operation-audit.jsonl`

---

## 2.8 fleet

### 什么时候用

- 你要看多仓健康，不是单仓诊断。

### 手动命令

```powershell
sbk fleet collect --roots E:\repo-a,E:\repo-b
sbk fleet report --format md
sbk fleet doctor
```

### 主要产物

- `.metrics/fleet-snapshot.json`
- `.metrics/fleet-report.json`

---

## 2.9 verify / gates

### 什么时候用

- 日常开发：`verify:fast`
- 提交前完整验证：`verify`
- 合并前模拟 CI：`verify:ci`
- 连续失败自动诊断：`verify:loop`

### 手动命令

```powershell
sbk verify:fast
sbk verify
sbk verify:ci
sbk verify:loop -- -Profile fast -MaxAttempts 2
```

补充门禁：

```powershell
sbk policy
sbk docs-sync
sbk skill-parity
sbk doctor
```

---

## 2.10 specs / context / session

### 手动命令

```powershell
sbk new-change <change-id>
sbk explore --change <change-id>
sbk migrate-specs --change <change-id>
sbk migrate-specs --change <change-id> --apply
sbk memory:context -- -Stage index
sbk record-session --help
```

---

## 3. 组合策略（直接抄）

## 3.1 新项目标准组合（稳定主线）

```powershell
sbk install --target-repo-root <repo> --preset minimal --channel stable
sbk greenfield --adapter node-ts --project-name demo --project-type backend --target-repo-root <repo>
sbk blueprint apply --name api-service --target-repo-root <repo> --project-name demo --adapter node-ts
sbk flow run --scenario greenfield --decision-mode auto --channel stable --target-repo-root <repo>
sbk verify:fast
```

## 3.2 存量项目保守接管组合

```powershell
sbk intake analyze --target-repo-root .
sbk intake plan --target-repo-root .
sbk intake verify --target-repo-root . --profile strict
sbk adapter doctor --target-repo-root .
sbk verify:fast
```

## 3.3 重构安全组合（先看影响再改名）

```powershell
sbk semantic reference-map --file <file> --line <n> --column <n> --target-repo-root .
sbk semantic safe-delete-candidates --file <file> --line <n> --column <n> --target-repo-root .
sbk semantic rename --file <file> --line <n> --column <n> --new-name <name> --dry-run --target-repo-root .
sbk semantic rename --file <file> --line <n> --column <n> --new-name <name> --target-repo-root .
sbk verify:fast
```

## 3.4 合并前组合（最小争议）

```powershell
sbk verify
sbk verify:ci
npm run metrics:collect
sbk policy
```

## 3.5 多仓治理组合

```powershell
sbk fleet collect --roots <repoA,repoB,repoC>
sbk fleet report --format md
sbk fleet doctor
```

---

## 4. AI 协作建议（什么时候交给 AI）

适合交给 AI 自动执行：

- 批量执行组合命令并回传总结。
- 失败后先跑 `verify:loop` 与 doctor 系列，再给修复顺序。
- 自动整理 `.metrics` 多份报告，提炼阻塞项。

建议你手动执行：

- 第一次 `install/upgrade`（避免目标路径输错）。
- 是否启用 Beta（这是风险决策，不是技术决策）。

---

## 5. 何时不用“组合策略”

- 你只需要查一个命令参数：直接看本篇“命令族速用”。
- 你要做能力对比：看 `05-相近功能辨析-怎么选与为什么.md`。
