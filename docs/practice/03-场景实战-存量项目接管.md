# 场景实战：存量项目接管（Brownfield）

适用场景：  
项目已经有历史代码、历史提交和已有 CI，你要把 SBK 接进来，但不想破坏现有节奏。

---

## 1. 接管原则（先稳再快）

- 先做风险盘点（`intake analyze`），不要一上来直接大改。
- 先让门禁“能解释失败”，再追求“全部通过”。
- 默认走 `stable + strict`，需要放宽时再降到 `balanced/lite`。

---

## 2. 前置动作（手动）

### 2.1 给目标仓安装 SBK（如果还没安装）

```powershell
sbk install --target-repo-root <目标仓库路径> --preset minimal --channel stable
```

### 2.2 进入目标仓库后做健康检查

```powershell
npm install
sbk adapter list
sbk doctor
```

---

## 3. Brownfield 接管主流程（手动）

### Step 1：风险分析

```powershell
sbk intake analyze --target-repo-root .
```

关键产物：

- `.metrics/intake-architecture-map.json`
- `.metrics/intake-risk-profile.json`

你重点看：

- `overallRiskScore`
- `recommendedProfile`
- 每个维度风险分（测试可靠性、变更热区、依赖复杂度、规格漂移、所有权扩散等）

### Step 2：生成硬化计划

```powershell
sbk intake plan --target-repo-root .
```

关键产物：

- `.metrics/intake-hardening-plan.json`
- `.metrics/intake-hardening-plan.md`

### Step 3：做接入就绪验证

```powershell
sbk intake verify --target-repo-root . --profile strict
```

如果 strict 失败，按顺序降级尝试：

```powershell
sbk intake verify --target-repo-root . --profile balanced
sbk intake verify --target-repo-root . --profile lite
```

关键产物：

- `.metrics/intake-readiness.json`
- `.metrics/intake-readiness.md`

### Step 4：适配器体检

```powershell
sbk adapter doctor --target-repo-root .
```

关键产物：

- `.metrics/adapter-doctor.json`
- `.metrics/adapter-doctor.md`

### Step 5：首轮编排（可选但推荐）

```powershell
sbk flow run --scenario brownfield --decision-mode auto --channel stable --target-repo-root .
```

触发语义说明：

- `flow run` 不会隐式触发 `sbk explore`、`sbk new-change`、`sbk record-session`。
- install 仅在传 `--with-install` 时执行。
- verify-fast 默认执行；传 `--skip-verify` 才会跳过。
- fleet 仅在传 `--fleet-roots` 时执行。
- 高风险显式开关：`--force`（覆盖行为）、`--allow-beta`（放开 beta 资产）。

---

## 4. 语义操作在存量项目里的正确用法

存量项目最怕“重命名误伤”。先 dry-run，再落地。

### 4.1 符号重命名（示例）

```powershell
sbk semantic rename --file src/app.ts --line 12 --column 10 --new-name NewName --dry-run --target-repo-root .
```

确认结果后去掉 `--dry-run` 再执行。

### 4.2 引用图与安全删除候选

```powershell
sbk semantic reference-map --file src/app.ts --line 12 --column 10 --max-results 200 --target-repo-root .
sbk semantic safe-delete-candidates --file src/app.ts --line 12 --column 10 --max-results 200 --target-repo-root .
```

关键产物：

- `.metrics/semantic-operation-report.json`
- `.metrics/semantic-operation-audit.jsonl`

---

## 5. Codex 提示词模板（可复制）

### 模板 1：存量接管标准动作

```text
请按 brownfield 接管流程在当前仓库自动执行：
1) sbk intake analyze --target-repo-root .
2) sbk intake plan --target-repo-root .
3) sbk intake verify --target-repo-root . --profile strict
4) 若 strict 失败，按 balanced -> lite 自动回退并记录原因
5) sbk adapter doctor --target-repo-root .
6) sbk verify:fast

要求：
- 输出一份“当前推荐 profile + 阻塞项 + 下一步最小行动列表”。
- 不要把 AI 自动执行理解为命令会隐式触发 explore/new-change。
- 若涉及 `--force` 或 `--allow-beta`，必须先说明原因与回滚方案再执行。
```

### 模板 2：高风险仓的保守接管

```text
这是一个高风险存量仓。请以“最小变更优先”方式工作：
1) 只读取脚本和配置，先做风险摘要（不改代码）
2) 执行 intake analyze/plan
3) 给出 strict 不通过时的修复优先级（最多 5 条）
4) 先不执行大规模重构，只执行能提升 verify:fast 通过率的动作
```

---

## 6. 成功判定

至少满足：

- `intake-readiness` 通过（至少 `balanced`）。
- `adapter doctor` 通过。
- `verify:fast` 通过。
- 关键报告均已落盘到 `.metrics/`。

---

## 7. 失败恢复：常见问题与恢复

### 问题 1：`strict` 一直不过

处理顺序：

1. 先保证 `balanced` 通过，建立稳定节奏。
2. 对照 `intake-hardening-plan.md` 修复阻塞项。
3. 每完成一项就重跑 `sbk intake verify --profile strict`。

### 问题 2：适配器识别不准确

处理：

1. `sbk capabilities` 看当前解析结果。
2. 在 `sbk.config.json` 显式设置 `adapter`。
3. 重跑 `sbk adapter doctor --adapter <name>`。

### 问题 3：语义操作失败

处理：

1. 检查 adapter 的 semantic capability 是否支持。
2. 先 `--dry-run`。
3. 确认对应语言后端依赖可用（Node/Python 等）。

---

## 8. 何时不用 brownfield 接管流程

- 这个仓本质是新项目空壳：用 `greenfield` 更快。
- 你只做 SBK 小版本更新：用 `upgrade` + `verify:fast` 即可。
