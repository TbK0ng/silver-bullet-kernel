# 场景实战：绿地项目（从 0 到 SBK 接管）

适用场景：  
你要启动一个新项目，目标是从第一天就把流程交给 SBK 管理。

---

## 1. 成功目标

你完成本篇后，应该达到：

- 项目里有完整规划骨架（`PROJECT.md`、`REQUIREMENTS.md` 等）。
- 已接入 `sbk` 入口和验证门禁。
- 至少一轮 `flow run` 成功，生成流程审计产物。
- 团队可以按同一套路继续开发，不靠口头传达。

---

## 2. 前置条件（手动）

### 2.1 如果你在 SBK 仓库给“目标仓库”安装内核

```powershell
sbk install --target-repo-root <你的目标仓库路径> --preset minimal --channel stable
```

说明：

- `minimal`：先够用，适合先跑通。
- `full`：文档与规范更全，适合直接做团队标准化。

### 2.2 进入目标仓库后检查入口

```powershell
sbk
```

---

## 3. 绿地主流程（手动）

### Step 1：生成项目级规划与语言最小脚手架

```powershell
sbk greenfield --adapter node-ts --project-name demo-app --project-type backend --target-repo-root .
```

说明：`sbk greenfield` 只生成规划与脚手架，不会自动触发 brainstorm/explore。

可选参数：

- 不想生成语言脚手架：`--no-language-stubs`
- 允许覆盖已存在文件：`--force`

### Step 2：选择并应用蓝图（建议）

先看可用蓝图：

```powershell
sbk blueprint list
```

再应用（稳定通道示例）：

```powershell
sbk blueprint apply --name api-service --target-repo-root . --project-name demo-app --adapter node-ts
sbk blueprint verify --target-repo-root .
```

如果蓝图文件已存在，需要：

```powershell
sbk blueprint apply --name api-service --target-repo-root . --project-name demo-app --adapter node-ts --force
```

### Step 3：初始化开发者身份与基础检查

```powershell
sbk init --owner codex --project-type backend
npm run workflow:doctor
```

### Step 4：跑通第一轮编排（推荐）

```powershell
sbk flow run --scenario greenfield --decision-mode auto --adapter node-ts --project-type backend --channel stable --target-repo-root .
```

触发语义说明：

- 仅当传 `--with-install` 时才会执行 install 阶段。
- 默认会执行 verify-fast；传 `--skip-verify` 才会跳过。
- `flow run` 不会自动触发 `sbk explore` / `sbk new-change`。

### Step 5：固化验证与指标

```powershell
sbk verify:fast
npm run metrics:collect
```

---

## 4. 你应当看到的产物

### 4.1 项目规划骨架（greenfield 产物）

- `PROJECT.md`
- `REQUIREMENTS.md`
- `ROADMAP.md`
- `STATE.md`
- `CONTEXT.md`
- `.planning/research/.gitkeep`

### 4.2 蓝图产物（按所选 blueprint 不同）

- `.sbk/blueprint.lock.json`
- `.github/workflows/ci.yml`
- `docs/practice/07-运维与治理-质量门禁与指标.md`（可作为运行手册基线）
- `docs/01-从Trellis到Silver-Bullet-Kernel的扩展全景.md`（可作为架构说明基线）
- `openspec/changes/<change>/proposal.md`（将 `<change>` 替换为实际 change slug）

### 4.3 流程与治理产物

- `.metrics/flow-run-report.json`
- `.metrics/verify-runs.jsonl`
- `.metrics/workflow-metrics-latest.json`

---

## 5. Codex 提示词模板（可复制）

### 模板 1：绿地自动落地

```text
请在当前仓库执行绿地接管流程，目标是 stable 主线可运行：
1) 先显式触发探索：/trellis:start（或 sbk explore --change <change-id>）
2) sbk greenfield --adapter node-ts --project-name demo-app --project-type backend --target-repo-root .
3) sbk blueprint list，并选择一个 stable 蓝图（优先 api-service）执行 apply + verify
4) sbk flow run --scenario greenfield --decision-mode auto --adapter node-ts --project-type backend --channel stable --target-repo-root .
5) sbk verify:fast
6) npm run metrics:collect

要求：
- 失败先修复再继续；
- 不要把 AI 自动执行理解为命令会隐式触发 explore/new-change；
- 最后输出“已生成产物清单 + 门禁状态 + 下一步开发建议”。
```

### 模板 2：蓝图冲突自动恢复

```text
如果 sbk blueprint apply 因文件已存在失败，请你：
1) 先评估是否安全覆盖
2) 若安全则追加 --force 重试
3) 重新执行 sbk blueprint verify
4) 总结覆盖了哪些文件，哪些文件未改动
```

---

## 6. 失败恢复：常见问题与恢复

### 问题 1：`blueprint verify` 失败（缺少 required artifacts）

恢复：

1. 先重跑 `sbk blueprint apply --name <蓝图名> ...`
2. 再跑 `sbk blueprint verify --target-repo-root .`
3. 查看 `.metrics/blueprint-verify.json` 里的 `missingArtifacts`

### 问题 2：`verify:fast` 失败

恢复：

1. `sbk verify:loop -- -Profile fast -MaxAttempts 2`
2. 查看 `.metrics/workflow-policy-gate.md` 与 `.metrics/workflow-doctor.md`
3. 修复后重跑 `sbk verify:fast`

### 问题 3：不小心用了 Beta 蓝图

恢复：

1. 先停在当前分支，不要直接合并。
2. 用 `stable` 蓝图重建一份对照分支。
3. 比对差异后再决定是否保留 Beta 变更。

---

## 7. 何时不用 greenfield

- 仓库已经有成熟代码和历史包袱：用 `intake analyze|plan|verify`（看 `03`）。
- 你只是升级已有 SBK 内核：用 `sbk upgrade`，不是 `greenfield`。
