# 运维与治理：质量门禁与指标

这篇关注“长期可持续运行”，不是一次性跑通。

---

## 1. 日常最小门禁链路（手动）

```powershell
sbk verify:fast
sbk doctor
```

提交前：

```powershell
sbk verify
```

合并前：

```powershell
sbk verify:ci
```

---

## 2. 各门禁的职责边界

## 2.1 `sbk policy`

检查重点：

- 变更是否可追踪到 OpenSpec artifacts
- 分支命名是否符合 `sbk-<owner>-<change>`
- 本地实现是否在 linked worktree
- 活跃变更 `tasks.md` 是否有 `Task Evidence` 且列结构完整
- 会话证据是否满足 owner 和披露元数据要求

产物：

- `.metrics/workflow-policy-gate.md`
- `.metrics/workflow-policy-gate.json`

## 2.2 `sbk docs-sync`

检查重点：

- 运行时相关文件变化时，是否同步更新必需文档
- 依据 `sbk.config.json` 中 `docsSync.requiredDocs` 判定

产物：

- `.metrics/workflow-docs-sync-gate.md`
- `.metrics/workflow-docs-sync-gate.json`

## 2.3 `sbk skill-parity`

检查重点：

- `.codex/.agents/.claude` 技能与命令映射是否一致

产物：

- `.metrics/workflow-skill-parity-gate.md`
- `.metrics/workflow-skill-parity-gate.json`

## 2.4 `sbk doctor`

检查重点：

- 运行环境、关键路径、各门禁健康状态总览

产物：

- `.metrics/workflow-doctor.md`
- `.metrics/workflow-doctor.json`

## 2.5 `npm run workflow:gate`（indicator gate）

检查重点（阈值来自 `workflow-policy.json`）：

- 最近 7 天失败率 `<= 5%`
- Lead Time P90 `<= 72h`
- 最近 7 天返工次数 `<= 2`
- 活跃变更数 `<= 3`
- 最近 30 天 spec drift `<= 1`

产物：

- `.metrics/workflow-indicator-gate.md`
- `.metrics/workflow-indicator-gate.json`

---

## 3. 指标采集与解释

## 3.1 采集命令（手动）

```powershell
npm run metrics:collect
```

核心产物：

- `.metrics/workflow-metrics-weekly.md`
- `.metrics/workflow-metrics-latest.json`

## 3.2 你该重点盯哪些字段

- `totals.last7DaysFailureRate`
- `indicators.leadTimeHoursP90`
- `indicators.reworkCountLast7Days`
- `indicators.specDriftEventsLast30Days`
- `indicators.tokenCost.status`

---

## 4. 连续失败时的标准恢复流程

```powershell
sbk verify:loop -- -Profile fast -MaxAttempts 2
sbk doctor
sbk policy
sbk docs-sync
```

恢复顺序建议：

1. 先修 `policy` 的 fail 项（否则后续都不稳定）。
2. 再修 `docs-sync`（防止运行时改动无文档证据）。
3. 最后修业务校验失败（lint/test/build）。

---

## 5. 周期性治理建议

## 每天（开发日）

```powershell
sbk verify:fast
```

## 每次提交前

```powershell
sbk verify
```

## 每次合并前

```powershell
sbk verify:ci
```

## 每周（团队复盘）

```powershell
npm run metrics:collect
npm run workflow:gate
```

---

## 6. Token 成本数据（可选但建议）

如果团队追踪模型调用成本，可写入：

```powershell
npm run metrics:token-cost -- -Source codex -TotalCostUsd 12.34 -TotalInputTokens 100000 -TotalOutputTokens 45000 -Notes "week-07"
```

产物：

- `.metrics/token-cost.json`

---

## 7. Codex 运维提示词模板

```text
请你做一次“治理体检 + 恢复建议”：
1) 执行 sbk doctor、sbk policy、sbk docs-sync、sbk skill-parity
2) 执行 npm run metrics:collect 和 npm run workflow:gate
3) 汇总所有 FAIL/WARN，按“必须今天修 / 本周修 / 可观察”分类
4) 对“必须今天修”给出可执行命令并自动执行前两项
```

---

## 8. 什么时候不要硬推门禁

- 你在做临时排障实验分支，可临时用 `balanced/lite` 收敛问题。
- 但回到主分支前，必须恢复到 `strict + stable` 并补齐证据。
