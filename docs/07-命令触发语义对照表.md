# 命令触发语义对照表

本页是“代码实锤版”触发语义基线，直接依据脚本实现整理。  
核对脚本范围：

- `scripts/sbk.ps1`
- `scripts/sbk-flow.ps1`
- `scripts/sbk-blueprint.ps1`
- `scripts/greenfield-bootstrap.ps1`
- `scripts/openspec-migrate-specs.ps1`

---

## 1. 术语约定

- 显式触发：必须由操作者明确调用命令或开关。
- 条件触发：仅在参数/上下文满足时触发阶段。
- 非触发：不会被流程隐式自动带出。
- 高风险显式触发：会放开覆盖/实验能力，需单独授权。

---

## 2. 显式触发总表（命令级）

| 对象 | 触发类型 | 说明 | 代码证据 |
| --- | --- | --- | --- |
| `sbk new-change` | 显式触发 | 仅在直接调用时创建 change 容器 | `scripts/sbk.ps1:312` |
| `sbk record-session` | 显式触发 | 仅在直接调用时写会话证据 | `scripts/sbk.ps1:319` |
| `sbk explore` | 显式触发 | 仅在直接调用时进入 explore 语境 | `scripts/sbk.ps1:324` |
| `sbk migrate-specs` | 显式触发 | 仅在直接调用时执行 delta->canonical 迁移流程 | `scripts/sbk.ps1:343` |
| `sbk parallel` | 显式触发 | 仅在直接调用时进入并行计划/执行入口 | `scripts/sbk.ps1:413` |
| `sbk init` | 显式触发 | 仅在直接调用时初始化 owner/workspace 上下文 | `scripts/sbk.ps1:417` |
| `sbk greenfield` | 显式触发 | 仅在直接调用时执行绿地初始化 | `scripts/sbk.ps1:353` |
| `sbk flow` | 显式触发入口 | 进入 flow 编排后再按条件触发阶段 | `scripts/sbk.ps1:365` |

---

## 3. 高风险显式触发（开关级）

| 开关 | 触发类型 | 影响 | 代码证据 |
| --- | --- | --- | --- |
| `flow --force` | 高风险显式触发 | 放开覆盖行为（含 install overwrite 与 blueprint force 语义） | `scripts/sbk-flow.ps1:467`, `scripts/sbk-flow.ps1:468`, `scripts/sbk-flow.ps1:502` |
| `flow --allow-beta` | 高风险显式触发 | 显式放开 beta 资产 | `scripts/sbk-flow.ps1:376`, `scripts/sbk-flow.ps1:500` |
| `migrate-specs --unsafe-overwrite` | 高风险显式触发 | canonical 采用 overwrite 而非 merge | `scripts/openspec-migrate-specs.ps1:5`, `scripts/openspec-migrate-specs.ps1:575`, `scripts/openspec-migrate-specs.ps1:593` |
| `blueprint --allow-beta` | 高风险显式触发 | 允许应用 beta blueprint | `scripts/sbk-blueprint.ps1:453`, `scripts/sbk-blueprint.ps1:467` |
| `blueprint --force` | 高风险显式触发 | 强制重写已有目标文件/lock | `scripts/sbk-blueprint.ps1:449`, `scripts/sbk-blueprint.ps1:374`, `scripts/sbk-blueprint.ps1:473` |
| `greenfield --force` | 高风险显式触发 | 覆盖已存在脚手架文件 | `scripts/greenfield-bootstrap.ps1:7`, `scripts/greenfield-bootstrap.ps1:64`, `scripts/greenfield-bootstrap.ps1:68` |

---

## 4. `flow run` 条件触发矩阵（阶段级）

| 阶段/行为 | 触发条件 | 未满足时 | 代码证据 |
| --- | --- | --- | --- |
| install core | `--with-install` | 不执行 install 阶段 | `scripts/sbk-flow.ps1:388`, `scripts/sbk-flow.ps1:461`, `scripts/sbk-flow.ps1:470` |
| greenfield bootstrap | `scenario=greenfield` | 不执行 greenfield 阶段 | `scripts/sbk-flow.ps1:426`, `scripts/sbk-flow.ps1:478`, `scripts/sbk-flow.ps1:488` |
| beta 资产放开 | `--channel beta` 或显式 `--allow-beta` | 走非 beta 资产路径 | `scripts/sbk-flow.ps1:447`, `scripts/sbk-flow.ps1:451`, `scripts/sbk-flow.ps1:500` |
| blueprint force 模式 | `--force`，或 `--with-install`，或目标仓已有 CI workflow 文件 | blueprint 按普通 apply 路径 | `scripts/sbk-flow.ps1:502`, `scripts/sbk-flow.ps1:503`, `scripts/sbk-flow.ps1:504` |
| verify fast | 未传 `--skip-verify` | 跳过 verify fast 阶段 | `scripts/sbk-flow.ps1:392`, `scripts/sbk-flow.ps1:558`, `scripts/sbk-flow.ps1:559` |
| fleet collect/report/doctor | 传入 `--fleet-roots` | 跳过 fleet 阶段 | `scripts/sbk-flow.ps1:396`, `scripts/sbk-flow.ps1:563`, `scripts/sbk-flow.ps1:565` |
| git 初始化 | 目标目录不是 git 仓 | 跳过 init | `scripts/sbk-flow.ps1:511`, `scripts/sbk-flow.ps1:513` |
| intake verify fallback | `decision-mode=auto` 且未显式传 profile | 不进入 fallback 候选扩展 | `scripts/sbk-flow.ps1:530`, `scripts/sbk-flow.ps1:532`, `scripts/sbk-flow.ps1:541` |

备注：`sbk` 顶层入口会把 `flow` 参数透传到 `sbk-flow.ps1`（`scripts/sbk.ps1:365`），因此 `--allow-beta`/`--force` 的运行时语义以 `scripts/sbk-flow.ps1` 为准。

---

## 5. 非触发清单（避免误读）

`flow run` 不会隐式触发：

- `explore`
- `new-change`
- `record-session`
- `parallel`

代码依据：`flow` 内实际 stage 调用仅包含 install/greenfield/blueprint/intake/adapter/verify/fleet，不包含上述命令。见 `scripts/sbk-flow.ps1:470`, `scripts/sbk-flow.ps1:488`, `scripts/sbk-flow.ps1:506`, `scripts/sbk-flow.ps1:522`, `scripts/sbk-flow.ps1:556`, `scripts/sbk-flow.ps1:559`, `scripts/sbk-flow.ps1:563`。

---

## 6. 提示词使用准则（防止语义漂移）

写提示词时必须分开写两层：

1. 显式步骤：你要 AI 执行的命令列表（例如先 `explore` 再 `flow run`）。
2. 条件阶段：`flow run` 内部哪些阶段应触发（如 `--with-install`、`--skip-verify`、`--fleet-roots`、是否允许 `--force/--allow-beta`）。

禁止把“AI 可代执行多步”写成“命令会隐式触发多步”。
