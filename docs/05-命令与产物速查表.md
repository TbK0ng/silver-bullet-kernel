# 命令与产物速查表

这是一页“作战卡”。  
你只需回答三个问题：

1. 我现在在哪个阶段。
2. 我该跑哪个命令。
3. 失败后看哪个证据文件。

约定：本页 `.metrics/*` 是运行产物，需执行对应命令后生成；带 `<target>` 的路径表示“目标仓库”而非当前仓库。

## 1. 阶段 -> 命令

| 阶段 | 目标 | 命令 |
| --- | --- | --- |
| 环境体检 | 确认工具链和结构健康 | `npm run workflow:doctor` |
| 快速自检 | 快速确认改动没越界 | `npm run verify:fast` |
| 完整验证 | 提交前闭环 | `npm run verify` |
| CI 等效验证 | 本地复现 CI 严格检查 | `npm run verify:ci` |
| 失败循环 | 有界诊断与重试 | `npm run verify:loop -- -Profile fast -MaxAttempts 2` |
| 指标采集 | 生成可观测快照 | `npm run metrics:collect` |
| 指标门禁 | 按阈值判定健康度 | `npm run workflow:gate` |
| 流程门禁 | 检查治理规则是否满足 | `npm run workflow:policy` |
| 文档同步门禁 | 防止运行时变更与文档脱节 | `npm run workflow:docs-sync` |
| Kernel 安装 | 向目标仓库安装 SBK 内核 | `npm run sbk -- install --target-repo-root <path> --preset minimal` |
| Kernel 升级 | 覆盖刷新目标仓库内核 | `npm run sbk -- upgrade --target-repo-root <path> --preset minimal` |
| Greenfield 初始化 | 生成项目级产物与语言脚手架 | `npm run sbk -- greenfield --adapter <node-ts|python|go|java|rust> --project-name <name>` |
| 一键全流程 | 条件化编排（`install` 需 `--with-install`；`--force/--allow-beta` 为显式高风险触发） | `npm run sbk -- flow run --target-repo-root <path> --decision-mode auto` |
| 需求探索（显式触发） | 进入 brainstorm / explore 语境 | `/trellis:start` 或 `npm run sbk -- explore --change <change-id>` |
| 统一入口 | 用单命令触发工作流动作 | `npm run sbk -- <subcommand>` |
| 记忆索引 | 最小上下文注入 | `npm run memory:context -- -Stage index` |
| 记忆详情 | 按 ID 拉取精确上下文 | `npm run memory:context -- -Stage detail -Ids S001,S003` |
| 语义重构 | 安全符号重命名 | `npm run refactor:rename -- --file <f> --line <n> --column <n> --newName <x> --dryRun` |
| 示例可用性 | 证明最小业务链路可用 | `npm run demo:smoke` |

## 2. 命令 -> 产物

| 命令 | 关键产物 |
| --- | --- |
| `verify:fast` / `verify` | `.metrics/verify-runs.jsonl` |
| `verify:ci` | `.metrics/verify-runs-ci.jsonl` |
| `verify:loop` | `.metrics/verify-fix-loop.jsonl` |
| `workflow:policy` | `.metrics/workflow-policy-gate.md`, `.metrics/workflow-policy-gate.json` |
| `workflow:docs-sync` | `.metrics/workflow-docs-sync-gate.md`, `.metrics/workflow-docs-sync-gate.json` |
| `metrics:collect` | `.metrics/workflow-metrics-weekly.md`, `.metrics/workflow-metrics-latest.json` |
| `workflow:gate` | `.metrics/workflow-indicator-gate.md`, `.metrics/workflow-indicator-gate.json` |
| `workflow:doctor` | `.metrics/workflow-doctor.md`, `.metrics/workflow-doctor.json` |
| `npm run sbk -- install ...` | 目标仓库内 `scripts/`、`workflow-policy.json`、`openspec/specs/` 等内核文件 |
| `npm run sbk -- upgrade ...` | 覆盖更新目标仓库已安装内核文件 |
| `npm run sbk -- greenfield ...` | `PROJECT.md`, `REQUIREMENTS.md`, `ROADMAP.md`, `STATE.md`, `CONTEXT.md`, `.planning/research/.gitkeep` |
| `npm run sbk -- flow run ...` | 始终有 `<target>/.metrics/flow-run-report.json`；`intake-readiness.json` / `blueprint-verify.json` 取决于阶段是否触发；beta/覆盖行为取决于 `--channel`、`--allow-beta`、`--force` |
| `npm run sbk -- semantic reference-map ...` | `<target>/.metrics/semantic-operation-report.json`, `<target>/.metrics/semantic-operation-audit.jsonl` |
| `npm run sbk -- semantic safe-delete-candidates ...` | `<target>/.metrics/semantic-operation-report.json`, `<target>/.metrics/semantic-operation-audit.jsonl` |
| `memory:context` | `.metrics/memory-context-audit.jsonl` |
| `map:codebase` | `.metrics/codebase-map.md` |
| `metrics:token-cost` | `.metrics/token-cost.json` |

## 3. 常用失败信号 -> 第一响应

| 失败信号 | 第一响应 |
| --- | --- |
| `workflow policy gate failed` | 打开 `.metrics/workflow-policy-gate.md`，修第一个 FAIL |
| `workflow indicator gate failed` | 先跑 `metrics:collect`，再看 `.metrics/workflow-indicator-gate.md` |
| `workflow doctor failed` | 打开 `.metrics/workflow-doctor.md`，按顺序修复失败项 |
| `workflow docs sync gate failed` | 打开 `.metrics/workflow-docs-sync-gate.md`，补齐 required docs |
| `metrics snapshot missing` | 执行 `npm run metrics:collect` |
| `Task evidence schema validation failed` | 修 `tasks.md` 的 `Task Evidence` 标题和列 |
| `Branch change id matches active change` 失败 | 统一分支 `<change>` 与 active change 名称 |
| `Local implementation runs from linked worktree` 失败 | 切到 `git worktree` 目录开发 |
| `secret-pattern scan` 失败 | 跑 `npm run secret:scan:diff`，脱敏后重试 |

## 4. 一套实战最小命令序列

开发中：

```powershell
npm run verify:fast
npm run sbk -- policy
```

准备提交：

```powershell
npm run verify
npm run workflow:doctor
```

做周复盘：

```powershell
npm run metrics:collect
npm run workflow:gate
npm run metrics:report:last
```

## 5. 目录角色速记

| 目录 | 角色 |
| --- | --- |
| `openspec/changes/` | 当前变更包（需求与执行证据） |
| `openspec/specs/` | 归档后的长期规格真相源 |
| `.trellis/workspace/<owner>/` | owner 级会话证据与恢复上下文 |
| `docs/` | 长期运行文档（稳定内容） |
| `.metrics/` | 运行时生成报告（可清理、可再生） |

一句话总结：  
日常看 `docs` 与 `docs/practice`，执行看命令，追责看 `.metrics` 与 OpenSpec 产物。
