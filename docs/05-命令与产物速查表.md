# 命令与产物速查表

这是一页“作战卡”。  
你只需回答三个问题：

1. 我现在在哪个阶段。
2. 我该跑哪个命令。
3. 失败后看哪个证据文件。

## 1. 阶段 -> 命令

| 阶段 | 目标 | 命令 |
| --- | --- | --- |
| 环境体检 | 确认工具链和结构健康 | `npm run workflow:doctor` |
| 快速自检 | 快速确认改动没越界 | `npm run verify:fast` |
| 完整验证 | 提交前闭环 | `npm run verify` |
| CI 等效验证 | 本地复现 CI 严格检查 | `npm run verify:ci` |
| 失败循环 | 有界诊断与重试 | `npm run verify:loop -- -Profile fast -MaxAttempts 2` |
| 指标采集 | 生成可观测快照 | `npm run metrics:collect` |
| 指标门禁 | 按阈值判定健康度 | `npm run workflow:gate` |
| 流程门禁 | 检查治理规则是否满足 | `npm run workflow:policy` |
| 记忆索引 | 最小上下文注入 | `npm run memory:context -- -Stage index` |
| 记忆详情 | 按 ID 拉取精确上下文 | `npm run memory:context -- -Stage detail -Ids S001,S003` |
| 语义重构 | 安全符号重命名 | `npm run refactor:rename -- --file <f> --line <n> --column <n> --newName <x> --dryRun` |
| 示例可用性 | 证明最小业务链路可用 | `npm run demo:smoke` |

## 2. 命令 -> 产物

| 命令 | 关键产物 |
| --- | --- |
| `verify:fast` / `verify` | `.metrics/verify-runs.jsonl` |
| `verify:ci` | `.metrics/verify-runs-ci.jsonl` |
| `verify:loop` | `.metrics/verify-fix-loop.jsonl` |
| `workflow:policy` | `.metrics/workflow-policy-gate.md`, `.metrics/workflow-policy-gate.json` |
| `metrics:collect` | `.metrics/workflow-metrics-weekly.md`, `.metrics/workflow-metrics-latest.json` |
| `workflow:gate` | `.metrics/workflow-indicator-gate.md`, `.metrics/workflow-indicator-gate.json` |
| `workflow:doctor` | `.metrics/workflow-doctor.md`, `.metrics/workflow-doctor.json` |
| `memory:context` | `.metrics/memory-context-audit.jsonl` |
| `map:codebase` | `.metrics/codebase-map.md` |
| `metrics:token-cost` | `.metrics/token-cost.json` |

## 3. 常用失败信号 -> 第一响应

| 失败信号 | 第一响应 |
| --- | --- |
| `workflow policy gate failed` | 打开 `.metrics/workflow-policy-gate.md`，修第一个 FAIL |
| `workflow indicator gate failed` | 先跑 `metrics:collect`，再看 `.metrics/workflow-indicator-gate.md` |
| `workflow doctor failed` | 打开 `.metrics/workflow-doctor.md`，按顺序修复失败项 |
| `metrics snapshot missing` | 执行 `npm run metrics:collect` |
| `Task evidence schema validation failed` | 修 `tasks.md` 的 `Task Evidence` 标题和列 |
| `Branch change id matches active change` 失败 | 统一分支 `<change>` 与 active change 名称 |
| `Local implementation runs from linked worktree` 失败 | 切到 `git worktree` 目录开发 |
| `secret-pattern scan` 失败 | 跑 `npm run secret:scan:diff`，脱敏后重试 |

## 4. 一套实战最小命令序列

开发中：

```powershell
npm run verify:fast
```

准备提交：

```powershell
npm run verify
npm run workflow:doctor
```

做周复盘：

```powershell
npm run metrics:collect
npm run workflow:gate
npm run metrics:report:last
```

## 5. 目录角色速记

| 目录 | 角色 |
| --- | --- |
| `openspec/changes/` | 当前变更包（需求与执行证据） |
| `openspec/specs/` | 归档后的长期规格真相源 |
| `.trellis/workspace/<owner>/` | owner 级会话证据与恢复上下文 |
| `xxx_docs/` | 长期运行文档（稳定内容） |
| `.metrics/` | 运行时生成报告（可清理、可再生） |

一句话总结：  
日常看 `xxx_docs` 和 `docs`，执行看命令，追责看 `.metrics` 与 OpenSpec 产物。
