# 多项目类型接入与配置指南

本文是 `sbk` 工具化接入手册，目标是：

1. 把 SBK 放进各种新项目（Node/Python/Go/Java/Rust）。
2. 保持业务代码结构不被工具逻辑污染。
3. 保持治理能力完整（默认 strict）。

## 1. 推荐接入形态

推荐使用 sidecar 目录（可作为子模块）：

```text
<your-project>/
  src/ ...
  tests/ ...
  .sbk/              # SBK 工具目录（建议）
```

如果你在本仓直接使用 SBK，也可以在仓根执行 `scripts/sbk.ps1`。

## 2. `sbk` 统一入口

统一入口命令：

```powershell
sbk <subcommand> [args]
```

等价脚本路径：`scripts/sbk.ps1`。

常用子命令：

- `sbk init --owner <name> [--project-type backend|frontend|fullstack]`
- `sbk greenfield [--adapter node-ts|python|go|java|rust] [--project-name <name>] [--project-type backend|frontend|fullstack] [--no-language-stubs] [--force]`
- `sbk blueprint [list|apply|verify] ...`
- `sbk intake [analyze|plan|verify] ...`
- `sbk adapter [list|validate|register|doctor] ...`
- `sbk semantic rename --file <path> --line <n> --column <n> --new-name <name> ...`
- `sbk fleet [collect|report|doctor] ...`
- `sbk install [--target-repo-root <path>] [--preset minimal|full] [--overwrite] [--skip-package-scripts]`
- `sbk install [--target-repo-root <path>] [--preset minimal|full] [--channel stable|beta] [--overwrite] [--skip-package-scripts]`
- `sbk upgrade [--target-repo-root <path>] [--preset minimal|full] [--channel stable|beta] [--skip-package-scripts]`
- `sbk capabilities [--platform <name>] [--target-repo-root <path>]`
- `sbk verify:fast`
- `sbk verify`
- `sbk verify:ci`
- `sbk verify:loop -- -Profile fast -MaxAttempts 2`
- `sbk policy`
- `sbk docs-sync`
- `sbk skill-parity`
- `sbk doctor`
- `sbk explore [--change <change-id>] [--include-apply-context]`
- `sbk improve-ut [--skip-validation]`
- `sbk migrate-specs [--change <change-id>] [--apply] [--unsafe-overwrite]`
- `sbk parallel [plan|start|status|cleanup] ...`
- `sbk new-change <change-id>`

`sbk greenfield` 用于 zero-to-one 初始化：

- 生成项目级产物：`PROJECT.md`、`REQUIREMENTS.md`、`ROADMAP.md`、`STATE.md`、`CONTEXT.md`
- 生成研究目录锚点：`.planning/research/.gitkeep`
- 按 adapter 生成最小语言脚手架（可用 `--no-language-stubs` 跳过）
- 默认只写缺失文件；使用 `--force` 才会覆盖已有文件

`sbk install` / `sbk upgrade` 用于把 SBK 内核分发到目标仓库：

- `install`: 默认非覆盖安装（已有文件跳过）
- `upgrade`: 覆盖模式刷新（等价 install + overwrite）
- `--preset minimal|full` 控制复制范围
- `--channel stable|beta` 控制发布通道，并执行通道兼容性检查
- `--target-repo-root` 指定目标仓库根目录

同时会在目标仓库落盘通道审计产物：

- `.sbk/release-manifest.json`
- `.metrics/channel-rollout-audit.jsonl`

## 3. Adapter（多生态适配）

内建 adapter：

- `node-ts`
- `python`
- `go`
- `java`
- `rust`

配置目录：`config/adapters/*.json`。

每个 adapter 定义：

- 识别标记（`detect.anyOfFiles`）
- 实现路径规则（`implementation.pathPrefixes/pathFiles`）
- 验证命令矩阵（`verify.fast/full/ci`）

## 4. Claude/Codex 能力矩阵（运行时真相）

能力矩阵由 `config/platform-capabilities.json` 维护，可用下列命令查看当前解析结果：

```powershell
sbk capabilities
```

矩阵覆盖项：

- `supportsCliAgents`
- `supportsSessionIdOnCreate`
- `supportsResume`
- `supportsSkipPermissions`
- `manualMode`

说明：

- Claude 支持 CLI 会话创建和 resume。
- Codex 在 Trellis multi-agent 中走 manual mode：不自动拉起后台 CLI 进程，但会完整创建 worktree、任务上下文和 registry 记录。

## 5. 运行时配置：`sbk.config.json`

关键字段：

- `adapter`: 指定 adapter，或设为 `auto`
- `profile`: `strict | balanced | lite`
- `targetRepoRoot`: 目标仓根路径（默认 `.`）
- `adaptersDir`: adapter 清单目录
- `docsSync`: 文档同步门禁配置

示例：

```json
{
  "adapter": "rust",
  "profile": "strict",
  "targetRepoRoot": ".",
  "adaptersDir": "config/adapters"
}
```

## 6. Profile（治理强度）

- `strict`：默认，全门禁开启。
- `balanced`：放宽部分会话证据约束。
- `lite`：进一步放宽分支/worktree/会话门禁，用于早期探索。

建议：默认 `strict`，仅在明确场景下短期切换。

## 7. 文档同步门禁（Docs Sync Gate）

命令：

```powershell
npm run workflow:docs-sync
# 或
sbk docs-sync
```

含义：当 runtime 相关文件（如 `scripts/`, `workflow-policy.json`, adapter 配置）变化时，必须同时更新要求的文档文件；否则门禁失败。

报告产物：

- `.metrics/workflow-docs-sync-gate.md`
- `.metrics/workflow-docs-sync-gate.json`

## 8. 技能与命令一致性门禁（Skill Parity Gate）

命令：

```powershell
npm run workflow:skill-parity
# 或
sbk skill-parity
```

含义：强制对齐三套分发面：

- `.codex/skills`
- `.agents/skills`
- `.claude/skills` + `.claude/commands`

报告产物：

- `.metrics/workflow-skill-parity-gate.md`
- `.metrics/workflow-skill-parity-gate.json`

## 9. 新项目最小落地步骤

1. 在 SBK 仓库运行安装：`sbk install --target-repo-root <your-repo> --preset minimal`。
2. 进入目标仓库，执行 greenfield 脚手架：`sbk greenfield --adapter <node-ts|python|go|java|rust> --project-name <name>`。
3. 初始化开发者身份：`sbk init --owner <name>`。
4. 视情况调整 `sbk.config.json`（profile/docsSync 等）。
5. 创建 change：`sbk new-change <change-id>`。
6. 开发过程中反复执行 `sbk verify:fast`。
7. 提交前执行 `sbk verify`，合并前执行 `sbk verify:ci`。

## 10. 常见问题

### Q1: auto 检测选错 adapter

A：在 `sbk.config.json` 里显式设置 `adapter`，或通过命令参数覆盖。

### Q2: docs sync gate 失败

A：按报告中的 `triggerHits` 与 `requiredDocs` 对应补文档后重跑。

### Q3: 本地验证通过但 CI 失败

A：优先用 `sbk verify:ci` 在本地复现，检查 base ref、active change、session evidence、docs sync 报告。

### Q4: Codex 为什么没有自动 resume 命令

A：这是平台能力差异。SBK 会在 multi-agent 模式里把 Codex 任务标记为 `manual`，你仍可在 worktree 中继续，并通过 `sbk capabilities` 查看当前平台能力矩阵与替代提示。

### Q5: 如何用 `sbk` 做并行任务分发？

A：使用 `sbk parallel` 统一入口：

- 规划：`sbk parallel plan --name <task> --type <backend|frontend|fullstack> --requirement "<desc>" --platform codex`
- 启动：`sbk parallel start <task-dir> --platform codex`
- 状态：`sbk parallel status`
- 清理：`sbk parallel cleanup <branch> -y`

### Q6: 如何把 delta specs 同步到 canonical specs？

A：先预览、后应用：

1. `sbk migrate-specs --change <change-id>`
2. `sbk migrate-specs --change <change-id> --apply`
3. `openspec validate --all --strict --no-interactive`

说明：
- `--apply` 默认是 requirement/scenario 级别的 merge，同名 requirement 会增量更新，不会整体覆盖 canonical spec 文件。
- 只有显式使用 `--unsafe-overwrite` 才会恢复覆盖式写入（高风险，不建议常规使用）。

### Q7: install 和 upgrade 的区别是什么？

A：

- `sbk install`：默认保护已有文件（跳过同名文件）。
- `sbk upgrade`：覆盖更新已安装文件，用于内核升级。

### Q8: blueprint / greenfield 的区别是什么？

A：

- `sbk greenfield`：项目级规划产物 + 语言最小脚手架。
- `sbk blueprint`：面向可上线基线的蓝图包（CI、runbook、安全、架构模板、OpenSpec 引导产物）。

建议先 `greenfield`，再 `blueprint apply`。

### Q9: brownfield 项目如何分阶段接入？

A：使用 `sbk intake` 三步：

1. `sbk intake analyze --target-repo-root <path>`
2. `sbk intake plan --target-repo-root <path>`
3. `sbk intake verify --target-repo-root <path> --profile strict`

产物统一在 `.metrics/`：

- `intake-architecture-map.md/json`
- `intake-risk-profile.md/json`
- `intake-hardening-plan.md/json`
- `intake-readiness.md/json`

### Q10: 如何扩展 adapter 并确保严格模式可用？

A：

1. `sbk adapter validate --path <adapter-pack>`
2. `sbk adapter register --path <adapter-pack>`
3. `sbk adapter doctor --target-repo-root <path>`

严格模式下会拒绝未验证插件 adapter。

### Q11: 多仓指标如何汇总？

A：

1. `sbk fleet collect --roots <repoA,repoB,...>`
2. `sbk fleet report --format md`
3. `sbk fleet doctor`

核心产物：

- `.metrics/fleet-snapshot.json`
- `.metrics/fleet-report.md/json`
- `.metrics/fleet-doctor.md/json`
